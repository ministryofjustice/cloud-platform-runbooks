<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
      <meta name="robots" content="noindex">

    <title>Cloud Platform Disaster Recovery - Cloud Platform Runbooks</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://runbooks.cloud-platform.service.justice.gov.uk/disaster-recovery.html">


      <meta property="og:image" content="https://runbooks.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="Cloud Platform Runbooks" />
      <meta property="og:title" content="Cloud Platform Disaster Recovery" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://runbooks.cloud-platform.service.justice.gov.uk/disaster-recovery.html" />
      <meta property="twitter:card" content="summary" />
      <meta property="twitter:domain" content="runbooks.cloud-platform.service.justice.gov.uk" />
      <meta property="twitter:image" content="https://runbooks.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="twitter:title" content="Cloud Platform Disaster Recovery - Cloud Platform Runbooks" />
      <meta property="twitter:url" content="https://runbooks.cloud-platform.service.justice.gov.uk/disaster-recovery.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          Cloud Platform Runbooks
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
      <nav>
        <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="mailto:platforms+runbooks@digital.justice.gov.uk?subject=Runbooks+feedback">Feedback / Report a problem</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/">Documentation</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="https://github.com/ministryofjustice/cloud-platform/tree/main/runbooks">GitHub</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search">
    <input type="hidden" name="as_sitesearch" value="https://runbooks.cloud-platform.service.justice.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input class="govuk-input govuk-!-margin-bottom-4" id="search" name="q" type="text" aria-controls="search-results" placeholder="Search">
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="polite">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading" data-module="collapsible-navigation">
                      <ul>
  <li>
    <a href="/#cloud-platform-runbooks"><span>Cloud Platform Runbooks</span></a>
  </li>
</ul>
<ul>
  <li>
    <a href="/how-we-work.html#how-we-work"><span>How We Work</span></a>
    <ul>
      <li>
        <a href="/how-we-work.html#getting-help"><span>Getting Help</span></a>
      </li>
      <li>
        <a href="/how-we-work.html#the-board-tickets"><span>The Board / Tickets</span></a>
        <ul>
          <li>
            <a href="/how-we-work.html#adding-tickets"><span>Adding tickets</span></a>
          </li>
          <li>
            <a href="/how-we-work.html#making-changes-to-code"><span>Making changes to code</span></a>
          </li>
          <li>
            <a href="/how-we-work.html#reviewing-merging-prs"><span>Reviewing/Merging PRs</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/how-we-work.html#the-hammer-of-justice"><span>The üî® Hammer of Justice</span></a>
        <ul>
          <li>
            <a href="/how-we-work.html#backlog-tickets"><span>Backlog Tickets</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/how-we-work.html#documentation"><span>Documentation</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/incident-process.html#incident-process"><span>Incident Process</span></a>
    <ul>
      <li>
        <a href="/incident-process.html#1-confirm-that-the-event-constitutes-an-incident"><span>1. Confirm that the event constitutes an incident</span></a>
      </li>
      <li>
        <a href="/incident-process.html#2-declare-the-incident"><span>2. Declare the incident</span></a>
        <ul>
          <li>
            <a href="/incident-process.html#examples"><span>Examples</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/incident-process.html#3-assign-roles"><span>3. Assign roles</span></a>
        <ul>
          <li>
            <a href="/incident-process.html#3-1-incident-lead"><span>3.1 Incident Lead</span></a>
          </li>
          <li>
            <a href="/incident-process.html#3-2-scribe"><span>3.2 Scribe</span></a>
          </li>
          <li>
            <a href="/incident-process.html#3-3-communications-lead"><span>3.3 Communications Lead</span></a>
          </li>
          <li>
            <a href="/incident-process.html#transferring-roles"><span>Transferring roles</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/incident-process.html#4-fix-the-problem"><span>4. Fix the problem</span></a>
      </li>
      <li>
        <a href="/incident-process.html#5-end-the-incident"><span>5. End the incident</span></a>
      </li>
      <li>
        <a href="/incident-process.html#6-post-incident-procedure"><span>6. Post-incident procedure</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/incident-log.html#incident-log"><span>Incident Log</span></a>
    <ul>
      <li>
        <a href="/incident-log.html#q1-2021-january-march"><span>Q1 2021 (January - March)</span></a>
        <ul>
          <li>
            <a href="/incident-log.html#no-incidents-declared"><span>No incidents declared</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/incident-log.html#q4-2020-october-december"><span>Q4 2020 (October - December)</span></a>
        <ul>
          <li>
            <a href="/incident-log.html#incident-on-2020-10-06-09-07-intermittent-quot-micro-downtimes-quot-on-various-services-using-dedicated-ingress-controllers"><span>Incident on 2020-10-06 09:07 - Intermittent ‚Äúmicro-downtimes‚Äù on various services using dedicated ingress controllers</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/incident-log.html#q3-2020-july-september"><span>Q3 2020 (July - September)</span></a>
        <ul>
          <li>
            <a href="/incident-log.html#incident-on-2020-09-28-13-10-termination-of-nodes-updating-kops-instance-group"><span>Incident on 2020-09-28 13:10 - Termination of nodes updating kops Instance Group.</span></a>
          </li>
          <li>
            <a href="/incident-log.html#incident-on-2020-09-21-18-27-some-cloud-platform-components-destroyed"><span>Incident on 2020-09-21 18:27 - Some cloud-platform components destroyed.</span></a>
          </li>
          <li>
            <a href="/incident-log.html#incident-on-2020-09-07-12-54-all-users-are-unable-to-create-new-ingress-rules"><span>Incident on 2020-09-07 12:54 - All users are unable to create new ingress rules</span></a>
          </li>
          <li>
            <a href="/incident-log.html#incident-on-2020-08-25-11-26-connectivity-issues-with-eu-west-2a"><span>Incident on 2020-08-25 11:26 - Connectivity issues with eu-west-2a</span></a>
          </li>
          <li>
            <a href="/incident-log.html#incident-on-2020-08-14-11-01-ingress-controllers-crashlooping"><span>Incident on 2020-08-14 11:01 - Ingress-controllers crashlooping</span></a>
          </li>
          <li>
            <a href="/incident-log.html#incident-on-2020-08-07-16-39-master-node-provisioning-failure"><span>Incident on 2020-08-07 16:39 - Master node provisioning failure</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/incident-log.html#q2-2020-april-june"><span>Q2 2020 (April - June)</span></a>
        <ul>
          <li>
            <a href="/incident-log.html#incident-on-2020-08-04-17-13"><span>Incident on 2020-08-04 17:13</span></a>
          </li>
          <li>
            <a href="/incident-log.html#incident-on-2020-04-15-10-58-nginx-tls"><span>Incident on 2020-04-15 10:58 Nginx/TLS</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/incident-log.html#q1-2020-january-march"><span>Q1 2020 (January - March)</span></a>
        <ul>
          <li>
            <a href="/incident-log.html#incident-on-2020-02-25-10-58"><span>Incident on 2020-02-25 10:58</span></a>
          </li>
          <li>
            <a href="/incident-log.html#incident-on-2020-02-18-14-13-utc"><span>Incident on 2020-02-18 14:13 UTC</span></a>
          </li>
          <li>
            <a href="/incident-log.html#incident-on-2020-02-12-11-45-utc"><span>Incident on 2020-02-12 11:45 UTC</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/incident-log.html#about-this-incident-log"><span>About this incident log</span></a>
      </li>
      <li>
        <a href="/incident-log.html#template"><span>Template</span></a>
        <ul>
          <li>
            <a href="/incident-log.html#incident-on-yyyy-mm-dd-hh-mm-brief-description"><span>Incident on YYYY-MM-DD HH:MM - [Brief description]</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/incident-log.html#key-events"><span>Key events</span></a>
      </li>
      <li>
        <a href="/incident-log.html#impact"><span>Impact:</span></a>
      </li>
      <li>
        <a href="/incident-log.html#context"><span>Context:</span></a>
      </li>
      <li>
        <a href="/incident-log.html#resolution"><span>Resolution:</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/create-cluster.html#create-a-new-cluster-2"><span>Create a new cluster</span></a>
    <ul>
      <li>
        <a href="/create-cluster.html#create-a-new-cluster-2-pre-requisites"><span>Pre-requisites</span></a>
      </li>
      <li>
        <a href="/create-cluster.html#environment-variables"><span>Environment Variables</span></a>
      </li>
      <li>
        <a href="/create-cluster.html#run-the-build-script-via-the-tools-image"><span>Run the build script, via the tools image</span></a>
      </li>
      <li>
        <a href="/create-cluster.html#alerts"><span>Alerts</span></a>
        <ul>
          <li>
            <a href="/create-cluster.html#apply-the-changes"><span>Apply the changes</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/create-cluster.html#authenticating"><span>Authenticating</span></a>
      </li>
      <li>
        <a href="/create-cluster.html#docker-authentication"><span>Docker authentication</span></a>
        <ul>
          <li>
            <a href="/create-cluster.html#adding-a-docker-config-file-to-your-cluster"><span>Adding a Docker config file to your cluster</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-concourse-to-cluster.html#add-concourse-to-a-test-cluster"><span>Add Concourse to a test cluster</span></a>
    <ul>
      <li>
        <a href="/add-concourse-to-cluster.html#add-concourse-to-a-test-cluster-pre-requisites"><span>Pre-requisites</span></a>
      </li>
      <li>
        <a href="/add-concourse-to-cluster.html#process"><span>Process</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/changes-in-cloudplatform.html#change-process-in-cloud-platform"><span>Change Process in Cloud Platform</span></a>
    <ul>
      <li>
        <a href="/changes-in-cloudplatform.html#making-changes-to-cloud-plarform-infrastructure"><span>Making Changes to cloud-plarform-infrastructure</span></a>
      </li>
      <li>
        <a href="/changes-in-cloudplatform.html#marking-changes-to-terraform-modules"><span>Marking Changes to terraform modules</span></a>
      </li>
      <li>
        <a href="/changes-in-cloudplatform.html#making-changes-to-helm-charts"><span>Making Changes to Helm Charts</span></a>
      </li>
      <li>
        <a href="/changes-in-cloudplatform.html#making-changes-to-environments-service-teams"><span>Making changes to environments (Service Teams)</span></a>
      </li>
      <li>
        <a href="/changes-in-cloudplatform.html#communications"><span>Communications</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/upgrade-cluster.html#upgrade-a-cluster"><span>Upgrade a cluster</span></a>
    <ul>
      <li>
        <a href="/upgrade-cluster.html#planning"><span>Planning</span></a>
      </li>
      <li>
        <a href="/upgrade-cluster.html#upgrade-a-cluster-pre-requisites"><span>Pre-requisites</span></a>
        <ul>
          <li>
            <a href="/upgrade-cluster.html#setup-environment"><span>Setup environment</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#run-the-integration-tests"><span>Run the integration tests</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#sanity-checks"><span>Sanity checks</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#run-a-shell-in-the-tools-image"><span>Run a shell in the tools image</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/upgrade-cluster.html#run-the-upgrade"><span>Run the upgrade</span></a>
        <ul>
          <li>
            <a href="/upgrade-cluster.html#authenticate-to-the-cluster"><span>Authenticate to the cluster</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#update-the-live-cluster-manifest"><span>Update the live cluster manifest</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#push-changes-to-kops-state"><span>Push changes to kops state</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#perform-a-rolling-update"><span>Perform a rolling-update</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#take-stock-of-current-running-worker-nodes"><span>Take stock of current running worker nodes</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#create-new-worker-instance-groups"><span>Create new worker instance groups</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#cordon-old-workers"><span>Cordon old workers</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#scale-the-number-of-ingress-controllers"><span>Scale the number of ingress controllers</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#drain-the-old-worker-nodes"><span>Drain the old worker nodes</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#validate-the-cluster"><span>Validate the cluster</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#run-the-integration-tests-again"><span>Run the integration tests again</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#delete-the-old-instance-groups"><span>Delete the old instance groups</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#scale-the-ingress-controllers-down"><span>Scale the ingress-controllers down</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/upgrade-cluster.html#commit-changes-back-to-main-branch"><span>Commit changes back to main branch</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/upgrade-eks-cluster.html#upgrade-eks-cluster-s"><span>Upgrade EKS cluster(s)</span></a>
    <ul>
      <li>
        <a href="/upgrade-eks-cluster.html#upgrade-eks-cluster-s-pre-requisites"><span>Pre-requisites</span></a>
      </li>
      <li>
        <a href="/upgrade-eks-cluster.html#upgrade-eks-cluster-s-run-the-upgrade"><span>Run the upgrade</span></a>
        <ul>
          <li>
            <a href="/upgrade-eks-cluster.html#upgrade-control-plane"><span>Upgrade Control Plane</span></a>
          </li>
          <li>
            <a href="/upgrade-eks-cluster.html#upgrade-node-groups"><span>Upgrade Node Groups</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/upgrade-terraform-version.html#upgrade-terraform-version"><span>Upgrade Terraform Version</span></a>
    <ul>
      <li>
        <a href="/upgrade-terraform-version.html#introduction"><span>Introduction</span></a>
      </li>
      <li>
        <a href="/upgrade-terraform-version.html#recommendations"><span>Recommendations</span></a>
      </li>
      <li>
        <a href="/upgrade-terraform-version.html#caveats"><span>Caveats</span></a>
      </li>
      <li>
        <a href="/upgrade-terraform-version.html#how-to-perform-the-upgrade-divide-and-conquer"><span>How to perform the upgrade - divide and conquer</span></a>
        <ul>
          <li>
            <a href="/upgrade-terraform-version.html#before-the-upgrade"><span>Before the upgrade</span></a>
          </li>
          <li>
            <a href="/upgrade-terraform-version.html#environments-state-files"><span>Environments state files</span></a>
          </li>
          <li>
            <a href="/upgrade-terraform-version.html#infrastructure-state-files"><span>Infrastructure state files</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/upgrade-cluster-components.html#upgrade-cluster-components"><span>Upgrade cluster components</span></a>
    <ul>
      <li>
        <a href="/upgrade-cluster-components.html#upgrade-cluster-components-planning"><span>Planning</span></a>
      </li>
      <li>
        <a href="/upgrade-cluster-components.html#testing-the-upgrade-in-a-test-cluster"><span>Testing the upgrade in a test cluster</span></a>
        <ul>
          <li>
            <a href="/upgrade-cluster-components.html#testing-the-upgrade-in-a-test-cluster-setup-environment"><span>Setup environment</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster-components.html#testing-the-upgrade-in-a-test-cluster-run-a-shell-in-the-tools-image"><span>Run a shell in the tools image</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster-components.html#authenticate-to-the-test-cluster"><span>Authenticate to the test cluster</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster-components.html#testing-the-upgrade-in-a-test-cluster-run-the-integration-tests"><span>Run the integration tests</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster-components.html#testing-the-upgrade"><span>Testing the upgrade</span></a>
          </li>
          <li>
            <a href="/upgrade-cluster-components.html#things-to-observe-when-testing-the-upgrade"><span>Things to observe when testing the upgrade</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/delete-cluster.html#delete-a-cluster"><span>Delete a cluster</span></a>
    <ul>
      <li>
        <a href="/delete-cluster.html#delete-the-cluster-using-the-script"><span>Delete the cluster using the script</span></a>
        <ul>
          <li>
            <a href="/delete-cluster.html#first-run-make-tools-shell"><span>First, run make tools-shell</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/delete-cluster.html#delete-the-cluster-using-concourse-fly-commands"><span>Delete the cluster using concourse fly commands</span></a>
      </li>
      <li>
        <a href="/delete-cluster.html#delete-the-cluster-manually"><span>Delete the cluster manually</span></a>
      </li>
      <li>
        <a href="/delete-cluster.html#delete-an-eks-cluster"><span>Delete an EKS cluster</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-nodes-to-the-cluster.html#add-nodes-to-the-cluster"><span>Add nodes to the cluster</span></a>
    <ul>
      <li>
        <ul>
          <li>
            <a href="/add-nodes-to-the-cluster.html#requirements"><span>Requirements</span></a>
          </li>
          <li>
            <a href="/add-nodes-to-the-cluster.html#inline-edit"><span>Inline edit</span></a>
          </li>
          <li>
            <a href="/add-nodes-to-the-cluster.html#persisting-the-changes"><span>Persisting the changes</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-nodes-to-the-eks-cluster.html#add-nodes-change-the-instance-type-of-the-aws-eks-cluster"><span>Add nodes/change the instance type of the AWS EKS cluster</span></a>
    <ul>
      <li>
        <a href="/add-nodes-to-the-eks-cluster.html#add-nodes-to-the-eks-cluster"><span>Add nodes to the eks cluster</span></a>
        <ul>
          <li>
            <a href="/add-nodes-to-the-eks-cluster.html#add-nodes-to-the-eks-cluster-requirements"><span>Requirements</span></a>
          </li>
          <li>
            <a href="/add-nodes-to-the-eks-cluster.html#cluster-configuration"><span>Cluster configuration:</span></a>
          </li>
          <li>
            <a href="/add-nodes-to-the-eks-cluster.html#issue"><span>Issue</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/add-nodes-to-the-eks-cluster.html#change-the-aws-eks-instance-type-worker-node-machine-type"><span>Change the AWS EKS instance type (worker_node_machine_type)</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/auth0-rotation.html#credentials-rotation-for-auth0-apps"><span>Credentials rotation for auth0 apps</span></a>
    <ul>
      <li>
        <a href="/auth0-rotation.html#preparation"><span>Preparation</span></a>
      </li>
      <li>
        <a href="/auth0-rotation.html#1-taint-resources-terraform"><span>1) Taint resources (terraform)</span></a>
      </li>
      <li>
        <a href="/auth0-rotation.html#2-rolling-update-of-cluster-kops"><span>2) Rolling update of cluster (kops)</span></a>
      </li>
      <li>
        <a href="/auth0-rotation.html#3-apply-changes-within-components-terraform"><span>3) Apply changes within components (terraform)</span></a>
      </li>
      <li>
        <a href="/auth0-rotation.html#4-update-environment-repo"><span>4) Update environment repo</span></a>
      </li>
      <li>
        <a href="/auth0-rotation.html#5-verifiying-changes"><span>5) Verifiying changes</span></a>
      </li>
      <li>
        <a href="/auth0-rotation.html#6-update-pipelines"><span>6) Update pipelines</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/rotate-git-crypt-key.html#git-crypt"><span>Git-crypt</span></a>
    <ul>
      <li>
        <a href="/rotate-git-crypt-key.html#adding-new-user-to-the-keyring"><span>Adding new user to the keyring</span></a>
      </li>
      <li>
        <a href="/rotate-git-crypt-key.html#rotating-the-git-crypt-key"><span>Rotating the git-crypt key</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/custom-domain.html#add-a-custom-domain"><span>Add a custom domain</span></a>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-new-receiver-alert-manager.html#add-a-new-alertmanager-receiver-and-a-slack-webhook"><span>Add a new Alertmanager receiver and a slack webhook</span></a>
    <ul>
      <li>
        <a href="/add-new-receiver-alert-manager.html#add-a-new-alertmanager-receiver-and-a-slack-webhook-pre-requisites"><span>Pre-requisites</span></a>
      </li>
      <li>
        <a href="/add-new-receiver-alert-manager.html#creating-a-new-receiver-set"><span>Creating a new receiver set</span></a>
      </li>
      <li>
        <a href="/add-new-receiver-alert-manager.html#information-alerts"><span>Information Alerts</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/disaster-recovery.html#cloud-platform-disaster-recovery"><span>Cloud Platform Disaster Recovery</span></a>
    <ul>
      <li>
        <a href="/disaster-recovery.html#restore-process"><span>Restore process</span></a>
      </li>
      <li>
        <a href="/disaster-recovery.html#apply-cloud-platform-resources"><span>Apply cloud-platform resources</span></a>
      </li>
      <li>
        <a href="/disaster-recovery.html#create-a-new-cluster"><span>Create a new cluster</span></a>
      </li>
      <li>
        <a href="/disaster-recovery.html#perform-the-restore"><span>Perform the restore</span></a>
        <ul>
          <li>
            <a href="/disaster-recovery.html#pre-requisites"><span>Pre-requisites</span></a>
          </li>
          <li>
            <a href="/disaster-recovery.html#restore-the-cluster-using-etcd-manager-ctl-on-your-computer"><span>Restore the cluster using etcd-manager-ctl on your computer.</span></a>
          </li>
          <li>
            <a href="/disaster-recovery.html#restore-process-inside-the-etcd-container-using-etcd-manager-ctl"><span>Restore process inside the etcd container using etcd-manager-ctl.</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/disaster-recovery.html#cleanup"><span>Cleanup</span></a>
      </li>
      <li>
        <a href="/disaster-recovery.html#possible-issues"><span>Possible Issues</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/disaster-recovery-scenarios.html#cloud-platform-disaster-recovery-scenarios"><span>Cloud Platform Disaster Recovery Scenarios</span></a>
    <ul>
      <li>
        <a href="/disaster-recovery-scenarios.html#losing-a-namespace"><span>Losing a Namespace</span></a>
        <ul>
          <li>
            <a href="/disaster-recovery-scenarios.html#losing-a-namespace-impact"><span>Impact</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#possible-cause"><span>Possible Cause</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#losing-a-namespace-restore-process"><span>Restore process</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/disaster-recovery-scenarios.html#losing-a-kubernetes-component-or-object"><span>Losing a Kubernetes Component or Object</span></a>
        <ul>
          <li>
            <a href="/disaster-recovery-scenarios.html#losing-a-kubernetes-component-or-object-impact"><span>Impact</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#losing-a-kubernetes-component-or-object-possible-cause"><span>Possible Cause</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#losing-a-kubernetes-component-or-object-restore-process"><span>Restore process</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/disaster-recovery-scenarios.html#losing-the-whole-cluster"><span>Losing the whole cluster</span></a>
        <ul>
          <li>
            <a href="/disaster-recovery-scenarios.html#losing-the-whole-cluster-impact"><span>Impact</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#losing-the-whole-cluster-possible-cause"><span>Possible Cause</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#how-this-plan-is-tested"><span>How this plan is tested:</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#assumptions"><span>Assumptions</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#losing-the-whole-cluster-restore-process"><span>Restore process</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/disaster-recovery-scenarios.html#deleted-corrupted-the-kops-state"><span>Deleted/corrupted the kops state</span></a>
        <ul>
          <li>
            <a href="/disaster-recovery-scenarios.html#deleted-corrupted-the-kops-state-impact"><span>Impact</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#deleted-corrupted-the-kops-state-possible-cause"><span>Possible Cause</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#restore-process-for-corrupted-kops-state"><span>Restore process for corrupted kops state</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#restore-process-for-deleted-s3-bucket-where-kops-state-is-stored"><span>Restore process for deleted S3 bucket where kops state is stored</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/disaster-recovery-scenarios.html#deleted-terraform-state"><span>Deleted terraform state</span></a>
        <ul>
          <li>
            <a href="/disaster-recovery-scenarios.html#deleted-terraform-state-impact"><span>Impact</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#deleted-terraform-state-possible-cause"><span>Possible Cause</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#deleted-terraform-state-restore-process"><span>Restore process</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#recovering-more-complex-scenarios"><span>Recovering more complex scenarios</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/disaster-recovery-scenarios.html#lost-or-corrupt-etcd-volume"><span>Lost or corrupt etcd volume</span></a>
        <ul>
          <li>
            <a href="/disaster-recovery-scenarios.html#lost-or-corrupt-etcd-volume-impact"><span>Impact</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#lost-or-corrupt-etcd-volume-possible-cause"><span>Possible Cause</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#lost-or-corrupt-etcd-volume-restore-process"><span>Restore process</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/disaster-recovery-scenarios.html#overwriting-kops-cluster-39-s-components-with-eks-components"><span>Overwriting KOPS cluster‚Äôs components with EKS components</span></a>
        <ul>
          <li>
            <a href="/disaster-recovery-scenarios.html#overwriting-kops-cluster-39-s-components-with-eks-components-impact"><span>Impact</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#overwriting-kops-cluster-39-s-components-with-eks-components-possible-cause"><span>Possible Cause</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#overwriting-kops-cluster-39-s-components-with-eks-components-restore-process"><span>Restore process</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#reproducing-incident-steps"><span>Reproducing Incident Steps</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#velero-backup"><span>Velero Backup</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#apply-the-eks-components-to-the-kops-cluster"><span>Apply the EKS components to the KOPS cluster</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#observations-of-incident"><span>Observations of Incident</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#destroy-the-eks-components"><span>Destroy the EKS components</span></a>
          </li>
          <li>
            <a href="/disaster-recovery-scenarios.html#re-apply-the-kops-components"><span>Re-apply the KOPS components</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/replacing-live1.html#replacing-live-1-would-be-hard-because"><span>Replacing Live-1 Would be Hard Because‚Ä¶</span></a>
    <ul>
      <li>
        <a href="/replacing-live1.html#reasons-replacing-live-1-is-hard"><span>Reasons replacing live-1 is hard:</span></a>
      </li>
      <li>
        <a href="/replacing-live1.html#solved-issues"><span>Solved issues</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/rotate-user-aws-credentials.html#rotate-user-aws-credentials"><span>Rotate User AWS Credentials</span></a>
    <ul>
      <li>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/rotate-user-aws-credentials.html#set-pingdom-environment-variables-optional"><span>Set pingdom environment variables(Optional)</span></a>
      </li>
      <li>
        <a href="/rotate-user-aws-credentials.html#target-the-live-1-cluster"><span>Target the live-1 cluster</span></a>
      </li>
      <li>
        <a href="/rotate-user-aws-credentials.html#set-cluster-related-environment-variables"><span>Set cluster related environment variables</span></a>
      </li>
      <li>
        <a href="/rotate-user-aws-credentials.html#set-the-namespace-name"><span>Set the namespace name</span></a>
      </li>
      <li>
        <a href="/rotate-user-aws-credentials.html#terraform-init"><span>Terraform Init</span></a>
      </li>
      <li>
        <a href="/rotate-user-aws-credentials.html#terraform-plan-apply"><span>Terraform Plan/Apply</span></a>
        <ul>
          <li>
            <a href="/rotate-user-aws-credentials.html#2-identify-the-compromised-terraform-object"><span>2. Identify the compromised terraform object</span></a>
          </li>
          <li>
            <a href="/rotate-user-aws-credentials.html#3-destroy-the-compromised-key"><span>3. Destroy the compromised key</span></a>
          </li>
          <li>
            <a href="/rotate-user-aws-credentials.html#4-let-terraform-create-a-new-key"><span>4. Let terraform create a new key</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/aws-leaked-credentials.html#aws-compromised-credentials"><span>AWS Compromised Credentials</span></a>
    <ul>
      <li>
        <a href="/aws-leaked-credentials.html#steps-for-a-leaked-credentials"><span>Steps for a leaked credentials</span></a>
      </li>
      <li>
        <a href="/aws-leaked-credentials.html#getting-new-credentials"><span>Getting new credentials</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/aws-create-user.html#aws-console-access"><span>AWS Console Access</span></a>
    <ul>
      <li>
        <a href="/aws-create-user.html#steps-to-create-delete-users"><span>Steps to create/delete users</span></a>
      </li>
      <li>
        <a href="/aws-create-user.html#activating-mfa-for-new-users"><span>Activating MFA for new users</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/public-s3-bucket.html#make-an-s3-bucket-public"><span>Make an S3 bucket public</span></a>
  </li>
</ul>
<ul>
  <li>
    <a href="/delete-prometheus-metrics.html#delete-prometheus-metrics"><span>Delete Prometheus Metrics</span></a>
    <ul>
      <li>
        <a href="/delete-prometheus-metrics.html#1-identify-the-metrics-you-want-to-delete"><span>1.  Identify the metrics you want to delete</span></a>
      </li>
      <li>
        <a href="/delete-prometheus-metrics.html#2-enable-the-admin-interface-in-prometheus"><span>2. Enable the admin interface in Prometheus</span></a>
      </li>
      <li>
        <a href="/delete-prometheus-metrics.html#3-launch-a-port-forward-pod"><span>3. Launch a port-forward pod</span></a>
      </li>
      <li>
        <a href="/delete-prometheus-metrics.html#4-forward-local-traffic-to-prometheus"><span>4. Forward local traffic to Prometheus</span></a>
      </li>
      <li>
        <a href="/delete-prometheus-metrics.html#5-use-curl-in-another-terminal-to-hit-the-api-endpoint"><span>5. Use curl (in another terminal) to hit the API endpoint</span></a>
      </li>
      <li>
        <a href="/delete-prometheus-metrics.html#6-use-this-script-to-delete-multiple-metrics"><span>6. Use this script to delete multiple metrics</span></a>
      </li>
      <li>
        <a href="/delete-prometheus-metrics.html#7-clean-up"><span>7. Clean up</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/manually-apply-namespace.html#manually-plan-apply-namespace-resources"><span>Manually Plan/Apply Namespace Resources</span></a>
    <ul>
      <li>
        <a href="/manually-apply-namespace.html#start-in-the-appropriate-branch-of-the-environments-repo"><span>Start in the appropriate branch of the environments repo</span></a>
      </li>
      <li>
        <a href="/manually-apply-namespace.html#manually-plan-apply-namespace-resources-set-pingdom-environment-variables-optional"><span>Set pingdom environment variables(Optional)</span></a>
      </li>
      <li>
        <a href="/manually-apply-namespace.html#manually-plan-apply-namespace-resources-target-the-live-1-cluster"><span>Target the live-1 cluster</span></a>
      </li>
      <li>
        <a href="/manually-apply-namespace.html#set-some-environment-variables"><span>Set some environment variables</span></a>
      </li>
      <li>
        <a href="/manually-apply-namespace.html#manually-plan-apply-namespace-resources-set-the-namespace-name"><span>Set the namespace name</span></a>
      </li>
      <li>
        <a href="/manually-apply-namespace.html#manually-plan-apply-namespace-resources-terraform-init"><span>Terraform Init</span></a>
      </li>
      <li>
        <a href="/manually-apply-namespace.html#manually-plan-apply-namespace-resources-terraform-plan-apply"><span>Terraform Plan/Apply</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/manually-delete-namespace-resources.html#manually-delete-namespace-resources"><span>Manually Delete Namespace Resources</span></a>
  </li>
</ul>
<ul>
  <li>
    <a href="/export-elasticsearch-to-csv.html#export-data-from-elasticsearch-into-a-csv-file"><span>Export data from Elasticsearch into a CSV file</span></a>
    <ul>
      <li>
        <a href="/export-elasticsearch-to-csv.html#workaround"><span>Workaround</span></a>
        <ul>
          <li>
            <a href="/export-elasticsearch-to-csv.html#install-es2csv"><span>Install es2csv</span></a>
          </li>
          <li>
            <a href="/export-elasticsearch-to-csv.html#usage"><span>Usage</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/remove-data-from-elasticsearch.html#remove-data-from-elasticsearch"><span>Remove data from Elasticsearch</span></a>
    <ul>
      <li>
        <a href="/remove-data-from-elasticsearch.html#stop-the-breach-first"><span>Stop the breach first</span></a>
      </li>
      <li>
        <a href="/remove-data-from-elasticsearch.html#things-to-know"><span>Things to know</span></a>
      </li>
      <li>
        <a href="/remove-data-from-elasticsearch.html#build-your-query"><span>Build your query</span></a>
      </li>
      <li>
        <a href="/remove-data-from-elasticsearch.html#delete-by-query"><span>Delete by query</span></a>
      </li>
      <li>
        <a href="/remove-data-from-elasticsearch.html#removing-specific-logs-filtered-by-phrase"><span>Removing specific logs filtered by phrase</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/delete-state-lock.html#delete-terraform-state-lock"><span>Delete terraform state lock</span></a>
    <ul>
      <li>
        <a href="/delete-state-lock.html#command-line-method"><span>Command-line method</span></a>
      </li>
      <li>
        <a href="/delete-state-lock.html#aws-console-method"><span>AWS Console method</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/error-refreshing-state.html#terraform-state-lock-error-refreshing-state"><span>Terraform state lock - Error refreshing state</span></a>
  </li>
</ul>
<ul>
  <li>
    <a href="/divergence-error.html#how-to-investigate-divergence-errors"><span>How to Investigate Divergence Errors</span></a>
    <ul>
      <li>
        <a href="/divergence-error.html#reproduce-the-plan"><span>Reproduce the plan</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/replacing-failed-master-node.html#recover-from-an-etcd-failure"><span>Recover from an etcd failure</span></a>
    <ul>
      <li>
        <a href="/replacing-failed-master-node.html#recover-from-an-etcd-failure-pre-requisites"><span>Pre-requisites</span></a>
      </li>
      <li>
        <a href="/replacing-failed-master-node.html#identify-the-failed-master-node"><span>Identify the failed master node</span></a>
      </li>
      <li>
        <a href="/replacing-failed-master-node.html#remove-the-unhealthy-etcd-member"><span>Remove the unhealthy etcd member.</span></a>
      </li>
      <li>
        <a href="/replacing-failed-master-node.html#replacing-the-failed-master-via-kops"><span>Replacing the failed master via kops</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/recycle-node.html#recycle-node"><span>Recycle-node</span></a>
    <ul>
      <li>
        <a href="/recycle-node.html#guidance-for-the-cloud-platform-team-when-the-recycle-node-pipeline-job-fails"><span>Guidance for the Cloud Platform team, when the recycle-node pipeline job fails:</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/multiple-clusters.html#managing-multiple-kops-clusters"><span>Managing Multiple Kops Clusters</span></a>
    <ul>
      <li>
        <a href="/multiple-clusters.html#overview"><span>Overview</span></a>
      </li>
      <li>
        <a href="/multiple-clusters.html#components-installed-only-in-live-1-cluster"><span>Components installed only in live-1 cluster</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/eks-tools-cluster.html#provisioning-eks-clusters"><span>Provisioning EKS clusters</span></a>
    <ul>
      <li>
        <a href="/eks-tools-cluster.html#provisioning-eks-clusters-pre-requisites"><span>Pre-requisites</span></a>
      </li>
      <li>
        <a href="/eks-tools-cluster.html#provisioning"><span>Provisioning</span></a>
        <ul>
          <li>
            <a href="/eks-tools-cluster.html#1-vpc"><span>1. VPC</span></a>
          </li>
          <li>
            <a href="/eks-tools-cluster.html#2-creating-eks-cluster"><span>2. Creating EKS cluster</span></a>
          </li>
          <li>
            <a href="/eks-tools-cluster.html#3-deploy-components"><span>3. Deploy components</span></a>
          </li>
          <li>
            <a href="/eks-tools-cluster.html#4-delete-the-eks-cluster"><span>4. Delete the EKS cluster</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/post-migration.html#post-migration-cleanup"><span>Post migration cleanup</span></a>
    <ul>
      <li>
        <a href="/post-migration.html#table-of-contents"><span>Table of contents</span></a>
      </li>
      <li>
        <a href="/post-migration.html#when-to-use-this-document"><span>When to use this document?</span></a>
      </li>
      <li>
        <a href="/post-migration.html#0-pre-requisites"><span>0. Pre-requisites</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#1-turn-off-template-deploy-monitoring-and-alerting"><span>1. Turn off Template Deploy monitoring and alerting</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#2-archive-the-deployment-repository"><span>2. Archive the deployment repository</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#3-backup-old-template-deploy-data"><span>3. Backup old Template Deploy data</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#4-delete-the-old-cloudformation-stack"><span>4. Delete the old CloudFormation stack</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#5-ensure-removal-of-resources"><span>5. Ensure removal of resources</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#6-ensure-live-service-is-still-functioning"><span>6. Ensure live service is still functioning!</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/expand.html#expanding-persistent-volumes-created-using-statefulsets"><span>Expanding Persistent Volumes created using StatefulSets</span></a>
  </li>
</ul>
<ul>
  <li>
    <a href="/velero.html#velero-cluster-backups-and-disaster-recovery"><span>Velero - Cluster backups and disaster recovery</span></a>
    <ul>
      <li>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/velero.html#backups"><span>Backups</span></a>
        <ul>
          <li>
            <a href="/velero.html#why"><span>Why?</span></a>
          </li>
          <li>
            <a href="/velero.html#what"><span>What?</span></a>
          </li>
          <li>
            <a href="/velero.html#how"><span>How?</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/sonarqube-scan.html#sonarqube-code-quality-and-security-scanning"><span>Sonarqube - Code quality and security scanning</span></a>
    <ul>
      <li>
        <a href="/sonarqube-scan.html#sonarqube-scanning"><span>Sonarqube scanning</span></a>
        <ul>
          <li>
            <a href="/sonarqube-scan.html#sonarqube-scan-all-repositories"><span>Sonarqube scan all repositories</span></a>
          </li>
          <li>
            <a href="/sonarqube-scan.html#sonarqube-github-action"><span>Sonarqube Github Action</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/running-kops-update-rollingupdate.html#running-kops-update-and-rollingupdate"><span>Running Kops Update and Rollingupdate</span></a>
    <ul>
      <li>
        <a href="/running-kops-update-rollingupdate.html#using-kops-to-change-the-cluster"><span>Using kops to change the cluster</span></a>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#running-kops-update-and-rollingupdate-pre-requisites"><span>Pre-requisites</span></a>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#updating-the-kops-state"><span>Updating the kops state</span></a>
        <ul>
          <li>
            <a href="/running-kops-update-rollingupdate.html#generating-an-updated-kops-config-file"><span>Generating an updated kops config file</span></a>
          </li>
          <li>
            <a href="/running-kops-update-rollingupdate.html#applying-local-changes-to-the-kops-state-store"><span>Applying local changes to the kops state store</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#running-kops-update"><span>Running Kops update</span></a>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#running-kops-rolling-update"><span>Running Kops rolling-update</span></a>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#possible-errors"><span>Possible Errors</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/helm-repository.html#cloud-platform-helm-chart-repository"><span>Cloud Platform helm chart repository</span></a>
    <ul>
      <li>
        <a href="/helm-repository.html#performing-crud-on-cloud-platform-helm-repository"><span>Performing CRUD on Cloud Platform Helm repository</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/auth-keys.html#how-to-add-authorized-keys"><span>How to add authorized keys</span></a>
  </li>
</ul>
<ul>
  <li>
    <a href="/access-eks-cluster.html#access-eks-cluster"><span>Access EKS cluster</span></a>
    <ul>
      <li>
        <a href="/access-eks-cluster.html#access-eks-cluster-pre-requisites"><span>Pre-requisites</span></a>
        <ul>
          <li>
            <a href="/access-eks-cluster.html#create-kubeconfig-using-aws-command"><span>Create kubeconfig using aws command</span></a>
          </li>
          <li>
            <a href="/access-eks-cluster.html#create-kubeconfig-manually-using-a-template"><span>Create kubeconfig manually using a template</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/destroy-concourse-build-data.html#destroy-concourse-build-data"><span>Destroy Concourse Build Data</span></a>
    <ul>
      <li>
        <a href="/destroy-concourse-build-data.html#destroy-concourse-build-data-overview"><span>Overview</span></a>
      </li>
      <li>
        <a href="/destroy-concourse-build-data.html#steps-to-remove-the-build-data"><span>Steps to remove the build data</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/joiners-guide.html#onboarding-into-the-cloud-platform-team"><span>Onboarding into the Cloud Platform Team</span></a>
    <ul>
      <li>
        <a href="/joiners-guide.html#people-team"><span>People Team</span></a>
      </li>
      <li>
        <a href="/joiners-guide.html#service-desk"><span>Service Desk</span></a>
      </li>
      <li>
        <a href="/joiners-guide.html#sit-down-with-dm"><span>Sit down with DM</span></a>
      </li>
      <li>
        <a href="/joiners-guide.html#cloud-platform-team"><span>Cloud Platform team</span></a>
      </li>
      <li>
        <a href="/joiners-guide.html#access"><span>ACCESS</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/custom-default-backend.html#custom-default-backend"><span>Custom default-backend</span></a>
    <ul>
      <li>
        <ul>
          <li>
            <a href="/custom-default-backend.html#background"><span>Background</span></a>
          </li>
          <li>
            <a href="/custom-default-backend.html#use-platform-level-error-page"><span>Use platform-level error page</span></a>
          </li>
          <li>
            <a href="/custom-default-backend.html#not-use-platform-level-error-page"><span>Not use platform-level error page</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-new-opa-policy.html#open-policy-agent-policies"><span>Open Policy Agent policies</span></a>
    <ul>
      <li>
        <a href="/add-new-opa-policy.html#adding-a-policy"><span>Adding a policy</span></a>
      </li>
      <li>
        <a href="/add-new-opa-policy.html#writing-tests"><span>Writing tests</span></a>
      </li>
      <li>
        <a href="/add-new-opa-policy.html#references"><span>References</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/cloud-platform-to-tgw.html#adding-a-route-to-connect-to-a-tgw"><span>Adding a route to connect to a TGW</span></a>
    <ul>
      <li>
        <a href="/cloud-platform-to-tgw.html#quick-introduction"><span>Quick introduction</span></a>
      </li>
      <li>
        <a href="/cloud-platform-to-tgw.html#transit-gateway"><span>Transit Gateway</span></a>
      </li>
      <li>
        <a href="/cloud-platform-to-tgw.html#making-the-change"><span>Making the change</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/leavers-guide.html#leavers-guide"><span>Leavers Guide</span></a>
    <ul>
      <li>
        <a href="/leavers-guide.html#revoking-access"><span>Revoking Access</span></a>
        <ul>
          <li>
            <a href="/leavers-guide.html#digital-services"><span>Digital Services</span></a>
          </li>
          <li>
            <a href="/leavers-guide.html#aws-accounts"><span>AWS Accounts</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/scheduled-pr-reminders.html#scheduled-pr-reminders"><span>Scheduled PR Reminders</span></a>
    <ul>
      <li>
        <ul>
          <li>
            <a href="/scheduled-pr-reminders.html#steps-required-for-new-repositories"><span>Steps required for new repositories</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/grafana-dashboards.html#grafana-dashboards"><span>Grafana Dashboards</span></a>
    <ul>
      <li>
        <a href="/grafana-dashboards.html#kubernetes-number-of-pods-per-node"><span>Kubernetes Number of Pods per Node</span></a>
        <ul>
          <li>
            <a href="/grafana-dashboards.html#dashboard-layout"><span>Dashboard Layout</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/on-call.html#going-on-call"><span>Going on call</span></a>
    <ul>
      <li>
        <a href="/on-call.html#what-s-expected"><span>What‚Äôs expected?</span></a>
        <ul>
          <li>
            <a href="/on-call.html#expected"><span>Expected:</span></a>
          </li>
          <li>
            <a href="/on-call.html#not-expected"><span>Not Expected:</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/on-call.html#where-do-i-start"><span>Where do I start?</span></a>
      </li>
      <li>
        <a href="/on-call.html#what-do-i-get-for-being-on-call"><span>What do I get for being on call?</span></a>
      </li>
      <li>
        <a href="/on-call.html#civil-servants"><span>Civil servants</span></a>
      </li>
      <li>
        <a href="/on-call.html#contractors"><span>Contractors</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/cloud-platform-communications-plan.html#cloud-platform-communications-plan"><span>Cloud Platform Communications Plan</span></a>
    <ul>
      <li>
        <a href="/cloud-platform-communications-plan.html#the-plan"><span>The Plan</span></a>
      </li>
      <li>
        <a href="/cloud-platform-communications-plan.html#tips-on-format-of-communications"><span>Tips on format of communications</span></a>
        <ul>
          <li>
            <a href="/cloud-platform-communications-plan.html#tips-on-format-of-communications-examples"><span>Examples</span></a>
          </li>
          <li>
            <a href="/cloud-platform-communications-plan.html#things-to-include-in-incident-communications"><span>Things to include in incident communications</span></a>
          </li>
          <li>
            <a href="/cloud-platform-communications-plan.html#example"><span>Example</span></a>
          </li>
          <li>
            <a href="/cloud-platform-communications-plan.html#things-to-include-in-upgrade-communications"><span>Things to include in upgrade communications</span></a>
          </li>
          <li>
            <a href="/cloud-platform-communications-plan.html#tips-on-format-of-communications-example"><span>Example</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/cloud-platform-communications-plan.html#sharing-information-with-the-wider-ministry-of-justice-and-the-public"><span>Sharing information with the wider Ministry of Justice and the Public</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/tips-and-tricks.html#tips-and-tricks"><span>Tips and Tricks</span></a>
    <ul>
      <li>
        <a href="/tips-and-tricks.html#delete-an-rds-database-snapshot"><span>Delete an RDS database snapshot</span></a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#check-the-expiration-date-of-the-ssl-certificate-for-a-live-domain"><span>Check the expiration date of the SSL certificate for a live domain</span></a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#run-etcdctl-on-a-master-node"><span>Run etcdctl on a master node</span></a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#delete-a-quot-stuck-quot-resource"><span>Delete a ‚Äústuck‚Äù resource</span></a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#filter-namespaces-by-specific-label-or-annotation"><span>Filter namespaces by specific label or annotation</span></a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#find-all-pods-running-on-a-specific-worker-node"><span>Find all pods running on a specific worker node</span></a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#count-pods-running-on-all-nodes"><span>Count pods running on all nodes</span></a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#install-tmux-and-docker-on-the-live-1-bastion-host"><span>Install tmux and docker on the live-1 bastion host</span></a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#output-all-records-from-route53-as-a-csv-file"><span>Output all records from Route53 as a CSV file</span></a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#add-more-rss-feeds-to-cloud-platform-rss-channel"><span>Add more RSS feeds to #cloud-platform-rss channel</span></a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#find-files-which-don-39-t-contain-a-particular-string"><span>Find files which don‚Äôt contain a particular string</span></a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#get-aws-ec2-instance-information-for-a-node"><span>Get AWS EC2 instance information for a node</span></a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#create-a-one-off-job-to-repeat-a-cronjob"><span>Create a one-off job to repeat a cronjob</span></a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#hijack-a-concourse-job-container"><span>Hijack a concourse job container</span></a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#help-when-manually-deleting-aws-resources"><span>Help when manually deleting AWS resources</span></a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#find-out-why-your-namespace-isn-39-t-deleting"><span>Find out why your namespace isn‚Äôt deleting</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/template-deploy-run-books.html#template-deploy-runbooks"><span>Template-deploy Runbooks</span></a>
    <ul>
      <li>
        <a href="/template-deploy-run-books.html#general-incident-procedure"><span>General Incident Procedure</span></a>
      </li>
      <li>
        <a href="/template-deploy-run-books.html#existing-runbooks"><span>Existing Runbooks</span></a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-a-new-runbook.html#add-a-new-runbook"><span>Add a new runbook</span></a>
    <ul>
      <li>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <h1 id="cloud-platform-disaster-recovery">Cloud Platform Disaster Recovery</h1><p>Cloud Platform Kubernetes cluster deployed with kops use <a href="https://github.com/kopeio/etcd-manager">etcd-manager</a> to do backups periodically and before cluster modifications. Backups for both the main and events etcd clusters are stored in &lsquo;s3://cloud-platform-kops-state/${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk&rsquo; together with the cluster configuration.</p>
<p>In case of a disaster situation (total failure, Kops delete cluster, lost data, cluster issues etc.) it&rsquo;s possible to do a restore from the backup using <a href="https://github.com/kopeio/etcd-manager">etcd-manager</a>. Check <a href="https://github.com/kopeio/etcd-manager/blob/master/docs/backup-restore.md">etcd-manager backup restore</a> and <a href="https://github.com/kubernetes/kops/blob/master/docs/operations/etcd_backup_restore_encryption.md">kops backup restore</a> for more details.</p>
<h2 id="restore-process">Restore process</h2><p>Depending on the current state of the cluster, different recovery strategies are appropriate.</p>

<ul>
<li><p>In a disaster situation (total failure), where a cluster has been deleted by running <code>Kops delete cluster</code> and cloud-platform resources have been destroyed by running terraform destroy in <a href="https://github.com/ministryofjustice/cloud-platform-infrastructure/tree/main/terraform/cloud-platform">terraform/cloud-platform</a>, then start with <a href="/disaster-recovery.html#apply-cloud-platform-resources">apply-cloud-platform</a>.</p></li>
<li><p>In a disaster situation (Kops delete cluster) but cloud-platform resources are not affected (i.e. when you run terraform plan in <a href="https://github.com/ministryofjustice/cloud-platform-infrastructure/tree/main/terraform/cloud-platform">terraform/cloud-platform</a>, result should be <code>Plan: 0 to add, 0 to change, 0 to destroy</code>), then start with <a href="/disaster-recovery.html#create-a-new-cluster">create-a-new-cluster</a>.</p></li>
<li><p>In situations where cluster is available (running <code>Kops validate cluster</code>, should result in <code>Your cluster ${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk is ready</code>), but affected with (lost data, cluster issues etc.), start with <a href="/disaster-recovery.html#perform-the-restore">perform-the-restore</a></p></li>
</ul>
<h2 id="apply-cloud-platform-resources">Apply cloud-platform resources</h2><p>This <a href="https://github.com/ministryofjustice/cloud-platform-infrastructure/tree/main/terraform/cloud-platform">terraform/cloud-platform</a> directory contains resources for the Cloud Platform environments - e.g. bastion hosts and kops. This will apply the outline of a Kubernetes cluster, including a kops.tf to be used to create or modify a cluster.</p>
<p>Before you begin, there are a few pre-reqs:</p>

<ul>
<li><p>Your GPG key must be added to the <a href="https://github.com/ministryofjustice/cloud-platform-infrastructure">cloud-platform-infrastructure</a> repo so you are able to <code>git-crypt unlock</code> before you make any changes</p></li>
<li><p>For the auth0 provider, setup the following environment variables locally:</p></li>
</ul>
<div class="highlight"><pre class="highlight plaintext"><code>  AUTH0_DOMAIN="justice-cloud-platform.eu.auth0.com"
  AUTH0_CLIENT_ID="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
  AUTH0_CLIENT_SECRET="yyyyyyyyyyyyyyyyyyyyyyyyyyyy"
</code></pre></div><p>To create a new cluster, use affected ${CLUSTER_NAME} terraform workspace if available, else create a new one with affected ${CLUSTER_NAME} and apply the <code>cloud-platform</code> resources. Ensure at all times that you are in the correct workspace with <code>$ terraform workspace show</code>.</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">export </span><span class="nv">AWS_PROFILE</span><span class="o">=</span>moj-cp
<span class="nv">$ </span><span class="nb">cd </span>terraform/cloud-platform
<span class="nv">$ </span>terraform init
<span class="nv">$ </span>terraform workspace <span class="k">select</span> <span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span>
<span class="nv">$ </span>terraform plan
<span class="nv">$ </span>terraform apply
</code></pre></div><p>Applying cloud-platform resources, terraform creates a <code>kops/${CLUSTER_NAME}.yaml</code> file in <a href="https://github.com/ministryofjustice/cloud-platform-infrastructure/tree/main/kops">kops</a> directory.</p>
<h2 id="create-a-new-cluster">Create a new cluster</h2><p>Use <code>kops</code> to create the cluster using <code>kops/${CLUSTER_NAME}.yaml</code>, which contains the cluster specification including an additional IAM policy to allow Route53 management, and config for OIDC authentication and RBAC.</p>
<p>If the cloud-platform resources were not destroyed in the disaster, use the existing <code>kops/${CLUSTER_NAME}.yaml</code> in <a href="https://github.com/ministryofjustice/cloud-platform-infrastructure/tree/main/kops">here</a> to create the cluster, else use the <code>kops/${CLUSTER_NAME}.yaml</code> file created by applying cloud-platform resources above.</p>
<p>Set environment variables.</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">export </span><span class="nv">KOPS_STATE_STORE</span><span class="o">=</span>s3://cloud-platform-kops-state
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CLUSTER_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span>.cloud-platform.service.justice.gov.uk
</code></pre></div><p>Use kops command as below to create the cluster.</p>
<div class="highlight"><pre class="highlight plaintext"><code>kops create -f ../../kops/${CLUSTER_NAME}.yaml
</code></pre></div><p>Create SSH public key in kops state store.</p>
<div class="highlight"><pre class="highlight plaintext"><code>kops create secret --name ${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk sshpublickey admin -i ~/.ssh/id_rsa.pub
</code></pre></div><p>Create cluster resources in AWS.
aka update cluster in AWS according to the yaml specification:</p>
<div class="highlight"><pre class="highlight plaintext"><code>kops update cluster ${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk --yes
</code></pre></div><p>When complete (takes around <code>30</code> minutes, as it will take time resolving the domain name of the new cluster for at least 15 minutes), you can check the progress with:</p>
<div class="highlight"><pre class="highlight plaintext"><code>kops validate cluster
</code></pre></div><p>Once it reports Your cluster <code>${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk is ready</code> you can proceed to use kubectl to interact with the cluster.</p>
<h2 id="perform-the-restore">Perform the restore</h2><p>When we have a working cluster (Kops validate cluster should show cluster in ready status), but the data is lost (example: namespaces got deleted, cloud-platform-components got destroyed) then restore cluster back to the point before disaster occurred using backup stored in &lsquo;s3://cloud-platform-kops-state/${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk/backups, by running etcd-manager-ctl.</p>
<p>To perform the restore, etcd-manager-ctl commands can be run in your <a href="/disaster-recovery.html#restore-the-cluster-using-etcd-manager-ctl-on-your-computer">terminal</a> as long as you have access to cluster s3 storage or they can be run inside the etcd <a href="/disaster-recovery.html#restore-process-inside-the-etcd-container-using-etcd-manager-ctl">container</a> on the master that is the leader of the cluster.</p>
<p>Please note that this process involves downtime for our masters (and so the api server). A restore cannot be undone (unless by restoring again), and we might lose pods, events and other resources that were created after the backup.</p>
<h3 id="pre-requisites">Pre-requisites</h3><p>Before you begin, there are a few pre-reqs:</p>

<ul>
<li>s3 bucket has latest backup you can use to restore.</li>
</ul>
<p>Sign in to the AWS Management Console and open the Amazon S3 console and access &#39;cloud-platform-kops-state/${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk/backups/etcd&rsquo;. In the etcd you will see <code>events</code> and <code>main</code> folders, In the <code>events</code> and <code>main</code> folders identify the file containing the timestamp you want to restore from.</p>
<p>Note: If the kops delete cluster was run, kops will delete the s3 bucket along with cluster, but as <code>s3://cloud-platform-kops-state</code> bucket is versioned you can access old versions of the backup.</p>
<h4 id="restore-deleted-s3-backups">Restore deleted s3 backups.</h4><p>To restore the deleted backups, follow the below steps:</p>
<p>Sign in to the AWS Management Console and open the Amazon S3 console and access &lsquo;cloud-platform-kops-state/${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk/backups/etcd.</p>
<p>Select main and click on <code>show</code> option in <code>versions</code>, you can view deleted backups now.</p>
<p>Click on the deleted backup you want to restore from, you will see <code>etcd_backup.meta</code> and <code>etcd.backup.gz</code> files set as (Delete marker).</p>
<p>Delete those (Delete marker) files by using delete option in actions (you can see in the below image), removing the delete marker files will get the backup files into active stage. Do the same for events.</p>
<p><a href="../images/s3-bucket-restore-from-deleted.png" target="_blank" rel="noopener noreferrer"><img src="/images/s3-bucket-restore-from-deleted.png" alt="s3 bucket restore from deleted" /></a></p>
<h3 id="restore-the-cluster-using-etcd-manager-ctl-on-your-computer">Restore the cluster using etcd-manager-ctl on your computer.</h3><p>Pre-requisites</p>

<ul>
<li>Install  kops-manager-ctl in your workstation. Run the below command by updating the latest <a href="https://github.com/kopeio/etcd-manager/releases/">release</a> version available for etcd-manager-ctl.</li>
</ul>
<div class="highlight"><pre class="highlight plaintext"><code>  curl -Lo etcd-manager-ctl  https://github.com/kopeio/etcd-manager/releases/download/3.0.20190816/etcd-manager-ctl-darwin-amd64 &amp;&amp; chmod +x etcd-manager-ctl &amp;&amp; mv etcd-manager-ctl /usr/local/bin
</code></pre></div><p>Run the below commands, to list the backups for main and events. We are listing backups for the cluster named <code>test-etcd-3.cloud-platform.service.justice.gov.uk</code> in a S3 bucket called <code>cloud-platform-kops-state</code>.</p>
<div class="highlight"><pre class="highlight plaintext"><code>etcd-manager-ctl --backup-store=s3://cloud-platform-kops-state/test-etcd-3.cloud-platform.service.justice.gov.uk/backups/etcd/main list-backups
etcd-manager-ctl --backup-store=s3://cloud-platform-kops-state/test-etcd-3.cloud-platform.service.justice.gov.uk/backups/etcd/events list-backups

</code></pre></div><p>you will see result as below for main and events.</p>
<div class="highlight"><pre class="highlight plaintext"><code>Backup Store: s3://cloud-platform-kops-state/test-etcd-3.cloud-platform.service.justice.gov.uk/backups/etcd/main
I0829 10:57:53.294703   34271 vfs.go:94] listed backups in s3://cloud-platform-kops-state/test-etcd-3.cloud-platform.service.justice.gov.uk/backups/etcd/main: [2019-08-27T16:44:23Z-001038 2019-08-29T09:23:52Z-000001 2019-08-29T09:24:36Z-000002 2019-08-29T09:38:59Z-000003 2019-08-29T09:54:03Z-000004]
2019-08-27T16:44:23Z-001038
2019-08-29T09:23:52Z-000001
2019-08-29T09:24:36Z-000002
2019-08-29T09:38:59Z-000003
2019-08-29T09:54:03Z-000004
</code></pre></div><p>Restore the latest backup in the list, or the one containing the timestamp you want to restore from (this will bring the entire cluster back to this point in time). Add a restore command for both main and events as below:</p>
<p>Note: We can only use a backup file which is returned in the results of the list-backups command. If kops deleted the backups it will not show up in the list. Follow this <a href="/disaster-recovery.html#restore-deleted-s3-backups">guidance</a> to get the deleted backups into active stage, which will then show up in the list-backups.</p>
<div class="highlight"><pre class="highlight plaintext"><code>etcd-manager-ctl -backup-store=s3://cloud-platform-kops-state/${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk/backups/etcd/main restore-backup 2019-08-27T16:44:23Z-001038

etcd-manager-ctl -backup-store=s3://cloud-platform-kops-state/${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk/backups/etcd/events restore-backup 2019-08-27T16:37:56Z-000351
</code></pre></div><p>This will add a command to a file in S3, which will be picked up by the etcd-manager leader. You will see the result as below for main and events.</p>
<div class="highlight"><pre class="highlight plaintext"><code>Backup Store: s3://cloud-platform-kops-state/test-etcd-3.cloud-platform.service.justice.gov.uk/backups/etcd/main
I0829 10:58:54.596932   34402 vfs.go:60] Adding command at s3://cloud-platform-kops-state/test-etcd-3.cloud-platform.service.justice.gov.uk/backups/etcd/main/control/2019-08-29T09:58:54Z-000000/_command.json: timestamp:1567072734596231000 restore_backup:&lt;cluster_spec:&lt;member_count:3 etcd_version:"3.3.10" &gt; backup:"2019-08-27T16:44:23Z-001038" &gt;
added restore-backup command: timestamp:1567072734596231000 restore_backup:&lt;cluster_spec:&lt;member_count:3 etcd_version:"3.3.10" &gt; backup:"2019-08-27T16:44:23Z-001038" &gt;
</code></pre></div><p>Note that this does not start the restore immediately, to start the restore, you need to roll masters quickly by <a href="/disaster-recovery.html#roll-masters-by-rebooting">rebooting</a> all the masters from the aws console or <a href="/disaster-recovery.html#restart-etcd">restart</a> etcd on all masters.</p>
<p>The etcd-manager containers should restart automatically, and pick up the restore command. A new etcd cluster will be created and the backup will be restored onto this new cluster.</p>
<h4 id="roll-masters-by-rebooting">Roll masters by rebooting</h4><p>To reboot all masters, follow below process.</p>
<p>In the Amazon EC2 console, on the Instances page, search using <code>${CLUSTER_NAME}</code> to locate cluster master and worker instances(<code>master-&lt;availability-zone&gt;.masters.&lt;cluster_name&gt;.cloud-platform.service.justice.gov.uk</code>).</p>
<p>Select all master instances together, and run reboot from actions&gt;instancestate&gt;reboot.
Run the below command to validate the cluster.</p>
<div class="highlight"><pre class="highlight shell"><code>kops validate cluster <span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span>.cloud-platform.service.justice.gov.uk
</code></pre></div><p>All master and worker node should join the cluster, you can see the cluster is in ready status.</p>
<div class="highlight"><pre class="highlight plaintext"><code>Your cluster ${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk is ready
</code></pre></div><p>Please note that this process might take a short while(around 1 hr), depending on the size of the cluster.</p>
<p>If the cluster is still in &#39;not ready&rsquo; status or you see other issues, this may be answered in <a href="/disaster-recovery.html#possible-issues">possible-issues</a> below.</p>
<h4 id="restart-etcd">Restart etcd</h4><p>To restart etcd on all masters, follow below process.</p>
<p>Note: If you rebooted all the master nodes, you don‚Äôt need to perform this step. Use this guidance is if rebooting the masters didn‚Äôt trigger the restore process.</p>
<p>login to master node via bastion instance:</p>
<div class="highlight"><pre class="highlight shell"><code>ssh <span class="nt">-A</span> admin@ec2-35-176-xx-xx.eu-west-2.compute.amazonaws.com <span class="nt">-p</span> 50422
</code></pre></div><p>From the bastion, login to any of the working master nodes:</p>
<div class="highlight"><pre class="highlight shell"><code>ssh 172.20.xx.xx
</code></pre></div><p>While SSHed onto a master:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>etcd.manager
</code></pre></div><p>You will see output as below:</p>
<div class="highlight"><pre class="highlight plaintext"><code>e81b4622417b  kopeio/etcd-manager         k8s_etcd-manager_etcd-manager-main-...
39c186fba5ea  kopeio/etcd-manager         k8s_etcd-manager_etcd-manager-events-...
8c77d710ce46  k8s.gcr.io/pause-amd64:3.0  k8s_POD_etcd-manager-main-...
806e5af8125d  k8s.gcr.io/pause-amd64:3.0  k8s_POD_etcd-manager-events-...
</code></pre></div><p>Using the container id for <code>k8s_etcd-manager_etcd-manager-main</code> and <code>k8s_etcd-manager_etcd-manager-events</code>, run the below command. This will restart the main and events.</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">sudo </span>docker <span class="nb">kill </span>e81b4622417b 39c186fba5ea
</code></pre></div><p>Immediately afterwards, exit out of the container. Repeat the steps above to login into other master nodes and restart <code>k8s_etcd-manager_etcd-manager-main</code> and <code>k8s_etcd-manager_etcd-manager-events</code> on all masters. Kubelet will restart them, and after a few seconds they should come up again and start syncing</p>
<p>You can follow the progress by reading the etcd logs (/var/log/etcd(-events).log) on the master that is the leader of the cluster.</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nb">tail</span> <span class="nt">-f</span> /var/log/etcd<span class="o">(</span><span class="nt">-events</span><span class="o">)</span>.log
</code></pre></div><h3 id="restore-process-inside-the-etcd-container-using-etcd-manager-ctl">Restore process inside the etcd container using etcd-manager-ctl.</h3><p>If you don&rsquo;t have etcd-manager-ctl installed on your workstation, you can run the etcd-manager-ctl restore process from a etcd container, follow the process below.</p>
<p>Note: If you already performed restore process via etcd-manager-ctl on your <a href="/disaster-recovery.html#restore-the-cluster-using-etcd-manager-ctl-on-your-computer">computer</a>, don&rsquo;t repeat this in etcd container.</p>
<p>Run the below command on all the etcd-manager-main and etcd-manager-event containers, to find out the leader of the cluster for main and events.</p>
<div class="highlight"><pre class="highlight plaintext"><code>kubectl -n kube-system logs etcd-manager-main-ip-172-xx-xx-226.eu-west-2.compute.internal | grep leader
</code></pre></div><p>you will see the logs as below, for events and main, which are the leaders of the cluster.</p>
<div class="highlight"><pre class="highlight plaintext"><code>etcd-manager-main-ip-172-xx-xx-226.eu-west-2.compute.internal etcd-manager I0830 ..... I am leader with token "xxxxxxxxxxx"
</code></pre></div><p>you will see the logs as below, for events and main, which are not the leaders of the cluster.</p>
<div class="highlight"><pre class="highlight plaintext"><code>etcd-manager-main-ip-172-xx-xx-223.eu-west-2.compute.internal etcd-manager I0830 ..... we are not leader
etcd-manager-main-ip-172-xx-xx-57.eu-west-2.compute.internal etcd-manager I0830  ..... we are not leader
</code></pre></div><p>From the above output, ssh in to leader master node via bastion instance:</p>
<p>In the Amazon EC2 console, on the Instances page, search using <code>${CLUSTER_NAME}</code>to locate bastion instance (<code>bastion.&lt;cluster_name&gt;.cloud-platform.service.justice.gov.uk</code>). Use Public DNS (IPv4) In the description of the Instance to login in to bastion as below:</p>
<div class="highlight"><pre class="highlight shell"><code>ssh <span class="nt">-A</span> admin@ec2-35-176-xx-xx.eu-west-2.compute.amazonaws.com <span class="nt">-p</span> 50422
</code></pre></div><p>From the bastion, login to the leader master node:</p>
<p>In the Amazon EC2 console, on the Instances page, search using <code>${CLUSTER_NAME}</code> to locate master instance (<code>master-&lt;availability-zone&gt;.masters.&lt;cluster_name&gt;.cloud-platform.service.justice.gov.uk</code>). From the result above to identify the leader, use the ip address of the leader master node and ssh in to it.</p>
<div class="highlight"><pre class="highlight shell"><code>ssh 172.20.xx.xx
</code></pre></div><p>While SSHed onto a master:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>etcd.manager
</code></pre></div><p>You will see output as below:</p>
<div class="highlight"><pre class="highlight plaintext"><code>e81b4622417b  kopeio/etcd-manager         k8s_etcd-manager_etcd-manager-main-...
39c186fba5ea  kopeio/etcd-manager         k8s_etcd-manager_etcd-manager-events-...
8c77d710ce46  k8s.gcr.io/pause-amd64:3.0  k8s_POD_etcd-manager-main-...
806e5af8125d  k8s.gcr.io/pause-amd64:3.0  k8s_POD_etcd-manager-events-...
</code></pre></div><p>Pick the main kopeio/etcd-manager container and then docker exec onto it</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">sudo </span>docker <span class="nb">exec</span> <span class="nt">-it</span> <span class="o">[</span>container <span class="nb">id</span><span class="o">]</span> bash
</code></pre></div><p>Run the following to install the etcd-manager-ctl binary, make sure you are using the latest <a href="https://github.com/kopeio/etcd-manager/releases/">release</a> version available for etcd-manager-ctl.</p>
<div class="highlight"><pre class="highlight plaintext"><code>apt-get update &amp;&amp; apt-get install -y wget
wget https://github.com/kopeio/etcd-manager/releases/download/3.0.20190816/etcd-manager-ctl-linux-amd64
mv etcd-manager-ctl-linux-amd64 etcd-manager-ctl
chmod +x etcd-manager-ctl
mv etcd-manager-ctl /usr/local/bin/
</code></pre></div><p>Still in the container, run etcd-manager-ctl commands to list the backups and restore the backups, following the guidance <a href="/disaster-recovery.html#restore-the-cluster-using-etcd-manager-ctl-on-your-computer">here</a>.</p>
<p>Do the exact same sequence of steps for the ‚Äúetcd-events‚Äù container. Backups will be stored in an s3 path ending with ‚Äúbackups/etcd/events‚Äù instead of ‚Äúbackups/etcd/main‚Äù, otherwise the steps are exactly the same.</p>
<h2 id="cleanup">Cleanup</h2><p>After the backup restore is completed, there are probably old master IPs being set as endpoints in the kubernetes service. You can fix this by manually removing the old master IPs from etcd.</p>
<p>Run the below command to identify the current masters:</p>
<div class="highlight"><pre class="highlight plaintext"><code>kubectl -n kube-system get pods | grep etcd-manager-main.
</code></pre></div><p>Result shown as below</p>
<div class="highlight"><pre class="highlight plaintext"><code>etcd-manager-events-ip-172-xx-xx-223.eu-west-2.compute.internal       1/1     Running   2          45m
etcd-manager-events-ip-172-xx-xx-226.eu-west-2.compute.internal       1/1     Running   2          47m
etcd-manager-events-ip-172-xx-xx-57.eu-west-2.compute.internal        1/1     Running   2          47m
</code></pre></div><p>Check the status of the kubernetes endpoint, running the below command:</p>
<div class="highlight"><pre class="highlight plaintext"><code>kubectl -n default get endpoints kubernetes -o=yaml
</code></pre></div><p>You can see the old master IPs being set as endpoints, from the below result:</p>
<div class="highlight"><pre class="highlight plaintext"><code>apiVersion: v1
kind: Endpoints
metadata:
  creationTimestamp: "2019-08-09T10:17:02Z"
  name: kubernetes
  namespace: default
  resourceVersion: "3492"
  selfLink: /api/v1/namespaces/default/endpoints/kubernetes
  uid: d4905523-ba8e-11e9-ba7f-06274dffb608
subsets:
- addresses:
  - ip: 172.xx.xx.223
  - ip: 172.xx.xx.245
  - ip: 172.xx.xx.226
  - ip: 172.xx.xx.255
  - ip: 172.xx.xx.57
  - ip: 172.xx.xx.20
  ports:
  - name: https
    port: 443
    protocol: TCP

</code></pre></div><p>or</p>
<p>You can get the old master IPs by describing the kubernetes service (under Endpoints):</p>
<div class="highlight"><pre class="highlight plaintext"><code> kubectl describe svc kubernetes
</code></pre></div><p>Result will be as below:</p>
<div class="highlight"><pre class="highlight plaintext"><code>Name:              kubernetes
Namespace:         default
Labels:            component=apiserver
                   provider=kubernetes
Annotations:       &lt;none&gt;
Selector:          &lt;none&gt;
Type:              ClusterIP
IP:                100.64.0.1
Port:              https  443/TCP
TargetPort:        443/TCP
Endpoints:         172.xx.xx.223:443,172.xx.xx.245:443,172.xx.xx.226:443,172.xx.xx.255:443,172.xx.xx.57:443,172.xx.xx.20:443
Session Affinity:  None
Events:            &lt;none&gt;
</code></pre></div><p>If the result shows ip addresses which do not belong to current masters, do the cleanup following the guidance below.</p>
<p>Exec into a pod running the etcd-main cluster and run the below command.</p>
<div class="highlight"><pre class="highlight plaintext"><code>ETCDCTL_API=3 /opt/etcd-v3.3.10-linux-amd64/etcdctl \
--key /rootfs/etc/kubernetes/pki/kube-apiserver/etcd-client.key \
--cert /rootfs/etc/kubernetes/pki/kube-apiserver/etcd-client.crt \
--cacert /rootfs/etc/kubernetes/pki/kube-apiserver/etcd-ca.crt \
--endpoints=https://127.0.0.1:4001 get --prefix /registry/masterleases/
</code></pre></div><p>The output will be as below:</p>
<div class="highlight"><pre class="highlight plaintext"><code>/registry/masterleases/172.xx.xx.245
k8s

v1¬†¬†Endpoints+

"*28MBz

172.xx.xx.245"
/registry/masterleases/172.xx.xx.223
k8s

v1¬†¬†Endpoints)

"*28MBz

172.xx.xx.223"
/registry/masterleases/172.xx.xx.255
k8s

v1¬†¬†Endpoints)

"*28MBz


172.xx.xx.255"
/registry/masterleases/172.xx.xx.244
k8s

v1¬†¬†Endpoints)

"*28MBz

172.xx.xx.244"
/registry/masterleases/172.xx.xx.20
k8s

v1¬†¬†Endpoints)

"*28MBz


172.xx.xx.20"
/registry/masterleases/172.xx.xx.57
k8s

v1¬†¬†Endpoints)

"*28MBz

172.xx.xx.57"
</code></pre></div><p>The output should match your master list. If it doesn‚Äôt, remove the redundant entries, for example like this:</p>
<div class="highlight"><pre class="highlight plaintext"><code>ETCDCTL_API=3 /opt/etcd-v3.3.10-linux-amd64/etcdctl \
--key /rootfs/etc/kubernetes/pki/kube-apiserver/etcd-client.key \
--cert /rootfs/etc/kubernetes/pki/kube-apiserver/etcd-client.crt \
--cacert /rootfs/etc/kubernetes/pki/kube-apiserver/etcd-ca.crt \
--endpoints=https://127.0.0.1:4001 del /registry/masterleases/172.xx.xx.245
</code></pre></div><p>After that‚Äôs done, rerun the below command.</p>
<div class="highlight"><pre class="highlight plaintext"><code>kubectl -n default get endpoints kubernetes -o=yaml
</code></pre></div><p>It should now list only ip addresses for your current master nodes.</p>
<div class="highlight"><pre class="highlight plaintext"><code>apiVersion: v1
kind: Endpoints
metadata:
  creationTimestamp: "2019-08-09T10:17:02Z"
  name: kubernetes
  namespace: default
  resourceVersion: "3492"
  selfLink: /api/v1/namespaces/default/endpoints/kubernetes
  uid: d4905523-ba8e-11e9-ba7f-06274dffb608
subsets:
- addresses:
  - ip: 172.xx.xx.223
  - ip: 172.xx.xx.226
  - ip: 172.xx.xx.57
  ports:
  - name: https
    port: 443
    protocol: TCP

</code></pre></div><h2 id="possible-issues">Possible Issues</h2>
<ul>
<li>After the restore-backup command is run and master nodes are rebooted, you may see the below issues when you run kops validate cluster.</li>
</ul>
<p>1) If any Master node stuck in <code>not ready</code> status, <a href="/disaster-recovery.html#roll-masters-by-rebooting">reboot</a> that master again, from the aws console or <a href="/disaster-recovery.html#restart-etcd">restart</a> etcd for that master node.</p>
<p>2) Master nodes are in ready status but worker nodes has not yet joined cluster</p>
<div class="highlight"><pre class="highlight plaintext"><code>NODE STATUS
NAME¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†ROLE¬†¬†¬†¬†READY
ip-172-20-58-111.eu-west-2.compute.internal¬†master¬†¬†True
ip-172-20-64-175.eu-west-2.compute.internal¬†master¬†¬†True
ip-172-20-97-124.eu-west-2.compute.internal¬†master¬†¬†True

VALIDATION ERRORS
KIND¬†¬†¬†¬†NAME¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†MESSAGE
Machine¬†i-04d61e3f17c896559¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†machine "i-04d61e3f17c896559" has not yet joined cluster
Machine¬†i-07cee6c33d3f9691f¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†machine "i-07cee6c33d3f9691f" has not yet joined cluster
Machine¬†i-0fe9ef38d7d424d4b¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†machine "i-0fe9ef38d7d424d4b" has not yet joined cluster
</code></pre></div><p>This may happen mainly for restoring disaster situation (total failure, kops delete cluster), as we are building the whole new cluster.</p>
<p>To fix this, reboot the worker nodes, they will be joining the cluster soon.</p>
<p>3) All master and worker nodes Joined the cluster, but we see below error&rsquo;s when we run kops validate cluster.</p>
<div class="highlight"><pre class="highlight plaintext"><code>NODE STATUS
NAME¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†ROLE¬†¬†¬†¬†READY
ip-172-20-108-76.eu-west-2.compute.internal¬†node¬†¬†¬†¬†True
ip-172-20-45-37.eu-west-2.compute.internal¬†¬†node¬†¬†¬†¬†True
ip-172-20-58-111.eu-west-2.compute.internal¬†master¬†¬†True
ip-172-20-64-175.eu-west-2.compute.internal¬†master¬†¬†True
ip-172-20-76-168.eu-west-2.compute.internal¬†node¬†¬†¬†¬†True
ip-172-20-97-124.eu-west-2.compute.internal¬†master¬†¬†True

VALIDATION ERRORS
KIND¬†¬†¬†¬†NAME¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†        MESSAGE
Pod¬†kube-system/calico-node-7xdcr¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†kube-system pod "calico-node-7xdcr" is not ready (calico-node)
Pod¬†kube-system/calico-node-88x5v¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†kube-system pod "calico-node-88x5v" is not ready (calico-node)
Pod¬†kube-system/calico-node-96s88¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†kube-system pod "calico-node-96s88" is pending
Pod¬†kube-system/calico-node-pz6n8¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†kube-system pod "calico-node-pz6n8" is pending
Pod¬†kube-system/calico-node-tgnfs¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†kube-system pod "calico-node-tgnfs" is not ready (calico-node)
Pod¬†kube-system/calico-node-vg5bd¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†kube-system pod "calico-node-vg5bd" is not ready (calico-node)
Pod¬†kube-system/cronjobber-7fbfcff575-zp2hd¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†kube-system pod "cronjobber-7fbfcff575-zp2hd" is pending
Pod¬†kube-system/etcd-manager-events-ip-..               ¬†¬†¬†¬†kube-system pod "etcd-manager-events-ip-.." is pending
Pod¬†kube-system/etcd-manager-main-ip-..             ¬†¬†¬†¬†    kube-system pod "etcd-manager-main-.." is pending
Pod¬†kube-system/external-dns-6fbd45b59c-r5vpk¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†kube-system pod "external-dns-6fbd45b59c-r5vpk" is pending
Pod¬†kube-system/external-dns-dsd-external-dns-..-fnx6l¬†¬†¬†¬†¬†¬†kube-system pod "external-dns-dsd-external-dns-67899b9dd7-fnx6l" is pending
Pod¬†kube-system/kube-apiserver-ip-..                ¬†¬†¬†¬†¬†¬†¬†¬†kube-system pod "kube-apiserver-ip-.." is pending
Pod¬†kube-system/kube-controller-manager-..              ¬†¬†¬†¬†kube-system pod "kube-controller-manager-.." is pending
Pod¬†kube-system/kube-dns-57dd96bb49-djtmq¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†kube-system pod "kube-dns-57dd96bb49-djtmq" is pending
Pod¬†kube-system/kube-dns-57dd96bb49-tqfqg¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†kube-system pod "kube-dns-57dd96bb49-tqfqg" is pending
Pod¬†kube-system/kube-dns-autoscaler-867b9fd49d-pblbg¬†¬†¬†¬†¬†¬†¬†¬†kube-system pod "kube-dns-autoscaler-867b9fd49d-pblbg" is pending
Pod¬†kube-system/kube-proxy-..                       ¬†¬†¬†¬†¬†¬†¬†¬†kube-system pod "kube-proxy-ip-.." is pending
Pod¬†kube-system/kube-scheduler-..¬†¬†¬†¬†¬†¬†¬†                    kube-system pod "kube-scheduler-ip-.." is pending
Pod¬†kube-system/metrics-server-c867fff7f-7x5zl¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†kube-system pod "metrics-server-c867fff7f-7x5zl" is pending
Pod¬†kube-system/tiller-deploy-6f6fd74b68-s68z5¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†kube-system pod "tiller-deploy-6f6fd74b68-s68z5" is pending
</code></pre></div><p>Pods use kubernetes.io/service-account-token to authenticate API requests. After the restore, old tokens (determined by checking creationTimestamp) are not removed, this is causing below errors for the pods which have this issue. So you will need to delete the old secrets, so they can be recreated with the correct keys.</p>
<div class="highlight"><pre class="highlight plaintext"><code>Unable to authenticate the request due to an error: [invalid bearer token, [invalid bearer token, square/go-jose: error in cryptographic primitive]
</code></pre></div><div class="highlight"><pre class="highlight plaintext"><code>kubectl -n kube-system get secrets --sort-by=.metadata.creationTimestamp
</code></pre></div><p>Comparing to the errors above, these are the tokens which are causing issues.</p>
<div class="highlight"><pre class="highlight plaintext"><code>NAME                                             TYPE                                  DATA   AGE
default-token-srztw                              kubernetes.io/service-account-token   3      20d
kube-proxy-token-x7p78                           kubernetes.io/service-account-token   3      20d
kube-dns-token-h6qfk                             kubernetes.io/service-account-token   3      20d
dns-controller-token-vtn85                       kubernetes.io/service-account-token   3      20d
kube-dns-autoscaler-token-dbm5d                  kubernetes.io/service-account-token   3      20d
calico-node-token-6w6p2                          kubernetes.io/service-account-token   3      20d
cronjobber-token-4n82j                           kubernetes.io/service-account-token   3      20d
tiller-token-xnmnx                               kubernetes.io/service-account-token   3      20d
metrics-server-token-t9pv9                       kubernetes.io/service-account-token   3      20d
external-dns-dsd-external-dns-token-w26ts        kubernetes.io/service-account-token   3      20d
external-dns-token-24kjn                         kubernetes.io/service-account-token   3      20d
</code></pre></div><p>Run the below command to delete the secrets, they will be recreated.</p>
<div class="highlight"><pre class="highlight plaintext"><code>kubectl -n kube-system delete secret default-token-srztw ......
</code></pre></div><p>Now delete the pods, they get recreated and start running.</p>
<div class="highlight"><pre class="highlight plaintext"><code>kubectl -n kube-system delete pods --all
</code></pre></div><p>4) Fixing issue 3, will get the cluster in to ready status, but we may see similar issue in other components below:</p>
<div class="highlight"><pre class="highlight plaintext"><code>NAME                  STATUS   AGE
cert-manager          Active   20d
ingress-controllers   Active   20d
kiam                  Active   20d
kuberos               Active   20d
logging               Active   20d
monitoring            Active   20d
opa                   Active   20d
</code></pre></div><p>Do the same approach as we did above, delete the old tokens and restart the pods.</p>
<p>5) In some scenarios, the in-cluster kubernetes service can become unavailable. As we are using calico for networking, this can mean that calico won&rsquo;t start up and stuck in pending status on (some) nodes.</p>
<p>This issue is due to old master IPs being set as endpoints in the kubernetes service. Fix this by manually removing the old master IPs from etcd by doing<a href="/disaster-recovery.html#cleanup">cleanup</a>.</p>


              <div data-module='page-expiry' data-last-reviewed-on="2021-06-01">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 1 March 2021.

        It needs to be reviewed again on 1 June 2021
        by the page owner <a href="https://mojdt.slack.com/messages/cloud-platform">#cloud-platform</a>
        .
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 1 June 2021
       by the page owner <a href="https://mojdt.slack.com/messages/cloud-platform">#cloud-platform</a>.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/ministryofjustice/cloud-platform/blob/main/runbooks/source/disaster-recovery.html.md.erb">View source</a></li>
                <li><a href="https://github.com/ministryofjustice/cloud-platform/issues/new?labels=bug&amp;title=Re:%20'Cloud%20Platform%20Disaster%20Recovery'&amp;body=Problem%20with%20'Cloud%20Platform%20Disaster%20Recovery'%20(https://runbooks.cloud-platform.service.justice.gov.uk/disaster-recovery.html)">Report problem</a></li>
                <li><a href="https://github.com/ministryofjustice/cloud-platform">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >¬© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
