<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
      <meta name="robots" content="noindex">

    <title>Create a new cluster | Cloud Platform Runbooks</title>

    <!--[if gt IE 8]><!--><link href="/stylesheets/screen.css" rel="stylesheet" media="screen" /><!--<![endif]-->
    <!--[if lte IE 8]><link href="/stylesheets/screen-old-ie.css" rel="stylesheet" media="screen" /><![endif]-->

    <link rel="canonical" href="https://runbooks.cloud-platform.service.justice.gov.uk/create-cluster.html">


    <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
    <script src="/javascripts/application.js"></script>

      <meta property="og:image" content="https://runbooks.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="Cloud Platform Runbooks" />
      <meta property="og:title" content="Create a new cluster" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://runbooks.cloud-platform.service.justice.gov.uk/create-cluster.html" />
      <meta property="twitter:card" content="summary" />
      <meta property="twitter:domain" content="runbooks.cloud-platform.service.justice.gov.uk" />
      <meta property="twitter:image" content="https://runbooks.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="twitter:title" content="Create a new cluster | Cloud Platform Runbooks" />
      <meta property="twitter:url" content="https://runbooks.cloud-platform.service.justice.gov.uk/create-cluster.html" />

    
  </head>

  <body>
    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="skip-link">Skip to main content</a>

        <header class="header header--full-width">
  <div class="header__container">
    <div class="header__brand">
        <a href="/">
        <span class="header__title">
          Cloud Platform Runbooks
            <span class="phase-banner">INTERNAL</span>
        </span>
        </a>
    </div>

      <div data-module="navigation">
        <button type="button" class="header__navigation-toggle js-nav-toggle" aria-controls="navigation" aria-label="Show or hide top level navigation">Menu</button>

        <nav id="navigation" class="header__navigation js-nav" aria-label="Top Level Navigation" aria-hidden="true">
          <ul>
              <li>
                <a href="mailto:platforms+runbooks@digital.justice.gov.uk?subject=Runbooks+feedback">Feedback / Report a problem</a>
              </li>
              <li>
                <a href="/">Documentation</a>
              </li>
              <li>
                <a href="https://github.com/ministryofjustice/cloud-platform/tree/master/runbooks">GitHub</a>
              </li>
          </ul>
        </nav>
      </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search">
    <input type="hidden" name="as_sitesearch" value="https://runbooks.cloud-platform.service.justice.gov.uk"/>
    <label for="search"  class="search__label">Search (via Google)</label>
    <input type="text" id="search" name="q" placeholder="Search" aria-controls="search-results" class="form-control" />
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="polite">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading" data-module="collapsible-navigation">
                      <ul>
  <li>
    <a href="/#cloud-platform-runbooks">Cloud Platform Runbooks</a>
  </li>
</ul>
<ul>
  <li>
    <a href="/create-cluster.html#create-a-new-cluster">Create a new cluster</a>
    <ul>
      <li>
        <a href="/create-cluster.html#pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/create-cluster.html#create-terraform-workspace">Create terraform workspace</a>
      </li>
      <li>
        <a href="/create-cluster.html#set-environment-variables-from-terraform-output">Set environment variables from terraform output</a>
      </li>
      <li>
        <a href="/create-cluster.html#use-kops-to-create-the-cluster">Use kops to create the cluster</a>
      </li>
      <li>
        <a href="/create-cluster.html#create-ssh-public-key-in-kops-state-store">Create SSH public key in kops state store.</a>
      </li>
      <li>
        <a href="/create-cluster.html#create-cluster-resources-in-aws">Create cluster resources in AWS.</a>
      </li>
      <li>
        <a href="/create-cluster.html#install-the-cloud-platform-components">Install the cloud-platform-components.</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/delete-cluster.html#delete-a-cluster">Delete a cluster</a>
  </li>
</ul>
<ul>
  <li>
    <a href="/rotate-user-aws-credentials.html#rotate-user-aws-credentials">Rotate User AWS Credentials</a>
    <ul>
      <li>
        <ul>
          <li>
          </li>
          <li>
            <a href="/rotate-user-aws-credentials.html#2-identify-the-compromised-terraform-object">2. Identify the compromised terraform object</a>
          </li>
          <li>
            <a href="/rotate-user-aws-credentials.html#3-destroy-the-compromised-key">3. Destroy the compromised key</a>
          </li>
          <li>
            <a href="/rotate-user-aws-credentials.html#4-let-terraform-create-a-new-key">4. Let terraform create a new key</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/remove-orphaned-namespace.html#remove-39-orphaned-39-namespaces-and-aws-resources">Remove ‘orphaned’ namespaces and AWS resources</a>
    <ul>
      <li>
        <ul>
          <li>
            <a href="/remove-orphaned-namespace.html#1-git-clone-the-environments-checker-repository">1. git clone the environments checker repository</a>
          </li>
          <li>
            <a href="/remove-orphaned-namespace.html#2-create-a-env-live1-file-containing-the-environment-variables-the-checker-requires">2. Create a .env.live1 file, containing the environment variables the checker requires</a>
          </li>
          <li>
            <a href="/remove-orphaned-namespace.html#3-do-a-dry-run-of-deleting-the-target-namespace">3. Do a dry run of deleting the target namespace</a>
          </li>
          <li>
            <a href="/remove-orphaned-namespace.html#4-delete-the-aws-resources-and-the-cluster-namespace">4. Delete the AWS resources and the cluster namespace</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/remove-orphaned-namespace.html#possible-errors">Possible Errors</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/post-migration.html#post-migration-cleanup">Post migration cleanup</a>
    <ul>
      <li>
        <a href="/post-migration.html#table-of-contents">Table of contents</a>
      </li>
      <li>
        <a href="/post-migration.html#when-to-use-this-document">When to use this document?</a>
      </li>
      <li>
        <a href="/post-migration.html#0-pre-requisites">0 Pre-requisites</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#1-turn-off-template-deploy-monitoring-and-alerting">1 Turn off Template Deploy monitoring and alerting</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#2-archive-the-deployment-repository">2 Archive the deployment repository</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#3-backup-old-template-deploy-data">3 Backup old Template Deploy data</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#4-delete-the-old-cloudformation-stack">4 Delete the old CloudFormation stack</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#5-ensure-removal-of-resources">5 Ensure removal of resources</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#6-ensure-live-service-is-still-functioning">6 Ensure live service is still functioning!</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-a-new-runbook.html#add-a-new-runbook">Add a new runbook</a>
    <ul>
      <li>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <h1 id="create-a-new-cluster">Create a new cluster</h1><h2 id="pre-requisites">Pre-requisites</h2><p>Before you begin, there are a few pre-reqs:</p>

<ul>
<li><p>Your GPG key must be added to the <a href="https://github.com/ministryofjustice/cloud-platform-infrastructure">infrastructure repo</a> so you are able to  <code>git-crypt unlock</code> before you make any changes</p></li>
<li><p>You must ensure your local <code>helm</code> version is =&gt; <code>2.11</code>. Also, <code>helm repo update</code> or you might see some failures at step 6.</p></li>
<li><p>The Auth0 Terraform provider isn&rsquo;t listed in the official Terraform repository. You must download the provider using <a href="https://github.com/yieldr/terraform-provider-auth0#using-the-provider">the instructions</a></p></li>
</ul>
<p>For the auth0 provider, setup the following environment variables locally:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">AUTH0_DOMAIN</span><span class="o">=</span><span class="s2">"justice-cloud-platform.eu.auth0.com"</span>
<span class="nv">AUTH0_CLIENT_ID</span><span class="o">=</span><span class="s2">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>
<span class="nv">AUTH0_CLIENT_SECRET</span><span class="o">=</span><span class="s2">"yyyyyyyyyyyyyyyyyyyyyyyyyyyy"</span>
</code></pre></div><p>The values are from the <code>terraform-provider-auth0</code> app on <a href="https://manage.auth0.com/#/applications">auth0</a></p>
<h2 id="create-terraform-workspace">Create terraform workspace</h2><p>Start from the root directory of a working copy of the <a href="https://github.com/ministryofjustice/cloud-platform-infrastructure">infrastructure repo</a>.</p>
<p>To create a new cluster, you must create a new terraform workspace and apply the <code>cloud-platform</code> resources.</p>
<p>Ensure at all times that you are in the correct workspace with <code>$ terraform workspace list</code>.</p>
<p>NB: In the commands below, your cluster name must be <strong>no more than 12 characters</strong>. Any longer, and some of the computed strings which include the cluster name will exceed their maximum allowed values. The error messages you get if this happens are unhelpful.</p>
<p>See our <a href="https://github.com/ministryofjustice/cloud-platform/blob/master/architecture-decision-record/009-Naming-convention-for-clusters.md">cluster naming policy</a>.</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">export </span><span class="nv">AWS_PROFILE</span><span class="o">=</span>moj-cp
<span class="nv">$ </span><span class="nb">cd </span>terraform/cloud-platform
<span class="nv">$ </span>terraform init
<span class="nv">$ </span>terraform workspace new &lt;clusterName e.g. cloud-platform-test-3&gt;
<span class="nv">$ </span>terraform plan
<span class="nv">$ </span>terraform apply
</code></pre></div><h2 id="set-environment-variables-from-terraform-output">Set environment variables from terraform output</h2><div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">export </span><span class="nv">KOPS_STATE_STORE</span><span class="o">=</span><span class="s2">"s3://</span><span class="k">$(</span>terraform output kops_state_store<span class="k">)</span><span class="s2">"</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CLUSTER_NAME</span><span class="o">=</span><span class="k">$(</span>terraform output cluster_name<span class="k">)</span>
</code></pre></div><h2 id="use-kops-to-create-the-cluster">Use kops to create the cluster</h2><p>Terraform creates a <code>kops/${CLUSTER_NAME}.yaml</code> file in your local directory. K8s release should track the version supported by Kops, check <a href="https://github.com/kubernetes/kops/releases">kops releases</a>.</p>
<p>Use <code>kops</code> to create your cluster.</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span>kops create <span class="nt">-f</span> ../../kops/<span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span>.yaml
</code></pre></div><h2 id="create-ssh-public-key-in-kops-state-store">Create SSH public key in kops state store.</h2><p>To create a new SSH public key for this purpose, run:</p>
<div class="highlight"><pre class="highlight shell"><code>ssh-keygen <span class="nt">-b</span> 4096 <span class="nt">-P</span> <span class="s1">''</span> <span class="nt">-f</span> ~/.ssh/mykey
</code></pre></div><p>Copy the SSH public key as a kops secret:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span>kops create secret <span class="nt">--name</span> <span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span>.cloud-platform.service.justice.gov.uk sshpublickey admin <span class="nt">-i</span> ~/.ssh/id_rsa.pub
</code></pre></div><h2 id="create-cluster-resources-in-aws">Create cluster resources in AWS.</h2><p>aka update cluster in AWS according to the yaml specification:</p>
<div class="highlight"><pre class="highlight shell"><code>kops update cluster <span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span>.cloud-platform.service.justice.gov.uk <span class="nt">--yes</span>
</code></pre></div><p>When complete (takes a few minutes), you can check the progress with:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span>kops validate cluster
</code></pre></div><p>Once it reports</p>

<blockquote>
<p>Your cluster <code>${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk is ready</code></p>
</blockquote>
<p>you can proceed to use kubectl to interact with the cluster.</p>
<h2 id="install-the-cloud-platform-components">Install the <code>cloud-platform-components</code>.</h2><div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">cd</span> ../cloud-platform-components
<span class="nv">$ </span>terraform init
<span class="nv">$ </span>terraform workspace new &lt;clusterName e.g. cloud-platform-test-3&gt;
<span class="nv">$ </span>terraform plan
<span class="nv">$ </span>terraform apply
</code></pre></div><p><em>Warning</em> a failure while installing <code>tiller</code> will make <code>helm</code> downgrade itself to v2.9, and nothing will work from there, doublecheck with</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ helm version
Client: &amp;version.Version{SemVer:"v2.11.0", GitCommit:"2e55dbe1fdb5fdb96b75ff144a339489417b146b", GitTreeState:"clean"}
Server: &amp;version.Version{SemVer:"v2.11.0", GitCommit:"2e55dbe1fdb5fdb96b75ff144a339489417b146b", GitTreeState:"clean"}
</code></pre></div><p>fix / destroy / apply again if the values don&rsquo;t match.</p>


            
          </main>

            <ul class="contribution-banner">
              <li><a href="https://github.com/ministryofjustice/cloud-platform/blob/master/source/create-cluster.html.md.erb">View source</a></li>
              <li><a href="https://github.com/ministryofjustice/cloud-platform/issues/new?labels=bug&amp;title=Re:%20'Create%20a%20new%20cluster'&amp;body=Problem%20with%20'Create%20a%20new%20cluster'%20(https://runbooks.cloud-platform.service.justice.gov.uk/create-cluster.html)">Report problem</a></li>
              <li><a href="https://github.com/ministryofjustice/cloud-platform">GitHub Repo</a></li>
            </ul>

          <footer class="footer">
  <div class="footer__licence">
    <a class="footer__licence-logo" href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence</a>
    <p class="footer__licence-description">All content is available under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence v3.0</a>, except where otherwise stated</p>
  </div>

  <div class="footer__copyright">
    <a class="footer__copyright-logo" href="http://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/copyright-and-re-use/crown-copyright/">© Crown copyright</a>
  </div>
</footer>

        </div>
      </div>
    </div>

    
  </body>
</html>
