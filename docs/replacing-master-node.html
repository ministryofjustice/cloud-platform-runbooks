<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
      <meta name="robots" content="noindex">

    <title>Replacing a master node | Cloud Platform Runbooks</title>

    <!--[if gt IE 8]><!--><link href="/stylesheets/screen.css" rel="stylesheet" media="screen" /><!--<![endif]-->
    <!--[if lte IE 8]><link href="/stylesheets/screen-old-ie.css" rel="stylesheet" media="screen" /><![endif]-->

    <link rel="canonical" href="https://runbooks.cloud-platform.service.justice.gov.uk/replacing-master-node.html">


    <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
    <script src="/javascripts/application.js"></script>

      <meta property="og:image" content="https://runbooks.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="Cloud Platform Runbooks" />
      <meta property="og:title" content="Replacing a master node" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://runbooks.cloud-platform.service.justice.gov.uk/replacing-master-node.html" />
      <meta property="twitter:card" content="summary" />
      <meta property="twitter:domain" content="runbooks.cloud-platform.service.justice.gov.uk" />
      <meta property="twitter:image" content="https://runbooks.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="twitter:title" content="Replacing a master node | Cloud Platform Runbooks" />
      <meta property="twitter:url" content="https://runbooks.cloud-platform.service.justice.gov.uk/replacing-master-node.html" />

    
  </head>

  <body>
    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="skip-link">Skip to main content</a>

        <header class="header header--full-width">
  <div class="header__container">
    <div class="header__brand">
        <a href="/">
        <span class="header__title">
          Cloud Platform Runbooks
            <span class="phase-banner">INTERNAL</span>
        </span>
        </a>
    </div>

      <div data-module="navigation">
        <button type="button" class="header__navigation-toggle js-nav-toggle" aria-controls="navigation" aria-label="Show or hide top level navigation">Menu</button>

        <nav id="navigation" class="header__navigation js-nav" aria-label="Top Level Navigation" aria-hidden="true">
          <ul>
              <li>
                <a href="mailto:platforms+runbooks@digital.justice.gov.uk?subject=Runbooks+feedback">Feedback / Report a problem</a>
              </li>
              <li>
                <a href="/">Documentation</a>
              </li>
              <li>
                <a href="https://github.com/ministryofjustice/cloud-platform/tree/master/runbooks">GitHub</a>
              </li>
          </ul>
        </nav>
      </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search">
    <input type="hidden" name="as_sitesearch" value="https://runbooks.cloud-platform.service.justice.gov.uk"/>
    <label for="search"  class="search__label">Search (via Google)</label>
    <input type="text" id="search" name="q" placeholder="Search" aria-controls="search-results" class="form-control" />
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="polite">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading" data-module="collapsible-navigation">
                      <ul>
  <li>
    <a href="/#cloud-platform-runbooks">Cloud Platform Runbooks</a>
  </li>
</ul>
<ul>
  <li>
    <a href="/create-cluster.html#create-a-new-cluster">Create a new cluster</a>
    <ul>
      <li>
        <a href="/create-cluster.html#create-a-new-cluster-pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/create-cluster.html#environment-variables">Environment Variables</a>
      </li>
      <li>
        <a href="/create-cluster.html#run-the-build-script-via-the-tools-image">Run the build script, via the tools image</a>
      </li>
      <li>
        <a href="/create-cluster.html#alerts">Alerts</a>
        <ul>
          <li>
            <a href="/create-cluster.html#apply-the-changes">Apply the changes</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-concourse-to-cluster.html#add-concourse-to-a-test-cluster">Add Concourse to a test cluster</a>
    <ul>
      <li>
        <a href="/add-concourse-to-cluster.html#add-concourse-to-a-test-cluster-pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/add-concourse-to-cluster.html#process">Process</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/upgrade-cluster.html#upgrade-a-cluster">Upgrade a cluster</a>
    <ul>
      <li>
        <a href="/upgrade-cluster.html#upgrade-a-cluster-pre-requisites">Pre-requisites</a>
        <ul>
          <li>
            <a href="/upgrade-cluster.html#upgrade-a-cluster-pre-requisites-environment-variables">Environment Variables</a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#sanity-checks">Sanity checks</a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#run-a-shell-in-the-tools-image">Run a shell in the tools image</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/upgrade-cluster.html#run-the-upgrade">Run the upgrade</a>
      </li>
      <li>
        <a href="/upgrade-cluster.html#upgrade-a-cluster-sanity-checks">Sanity checks</a>
      </li>
      <li>
        <a href="/upgrade-cluster.html#commit">Commit</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/delete-cluster.html#delete-a-cluster">Delete a cluster</a>
    <ul>
      <li>
        <a href="/delete-cluster.html#delete-the-cluster-using-the-script">Delete the cluster using the script</a>
      </li>
      <li>
        <a href="/delete-cluster.html#delete-the-cluster-manually">Delete the cluster manually</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-nodes-to-the-cluster.html#add-nodes-to-the-cluster">Add nodes to the cluster</a>
    <ul>
      <li>
        <ul>
          <li>
            <a href="/add-nodes-to-the-cluster.html#requirements">Requirements</a>
          </li>
          <li>
            <a href="/add-nodes-to-the-cluster.html#inline-edit">Inline edit</a>
          </li>
          <li>
            <a href="/add-nodes-to-the-cluster.html#persisting-the-changes">Persisting the changes</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/rotate-git-crypt-key.html#git-crypt">Git-crypt</a>
    <ul>
      <li>
        <a href="/rotate-git-crypt-key.html#adding-new-user-to-the-keyring">Adding new user to the keyring</a>
      </li>
      <li>
        <a href="/rotate-git-crypt-key.html#rotating-the-git-crypt-key">Rotating the git-crypt key</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/disaster-recovery.html#cloud-platform-disaster-recovery">Cloud Platform Disaster Recovery</a>
    <ul>
      <li>
        <a href="/disaster-recovery.html#restore-process">Restore process</a>
      </li>
      <li>
        <a href="/disaster-recovery.html#apply-cloud-platform-resources">Apply cloud-platform resources</a>
      </li>
      <li>
        <a href="/disaster-recovery.html#cloud-platform-disaster-recovery-create-a-new-cluster">Create a new cluster</a>
      </li>
      <li>
        <a href="/disaster-recovery.html#perform-the-restore">Perform the restore</a>
        <ul>
          <li>
            <a href="/disaster-recovery.html#perform-the-restore-pre-requisites">Pre-requisites</a>
          </li>
          <li>
            <a href="/disaster-recovery.html#restore-the-cluster-using-etcd-manager-ctl-on-your-computer">Restore the cluster using etcd-manager-ctl on your computer.</a>
          </li>
          <li>
            <a href="/disaster-recovery.html#restore-process-inside-the-etcd-container-using-etcd-manager-ctl">Restore process inside the etcd container using etcd-manager-ctl.</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/disaster-recovery.html#cleanup">Cleanup</a>
      </li>
      <li>
        <a href="/disaster-recovery.html#possible-issues">Possible Issues</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/rotate-user-aws-credentials.html#rotate-user-aws-credentials">Rotate User AWS Credentials</a>
    <ul>
      <li>
        <ul>
          <li>
          </li>
          <li>
            <a href="/rotate-user-aws-credentials.html#2-identify-the-compromised-terraform-object">2. Identify the compromised terraform object</a>
          </li>
          <li>
            <a href="/rotate-user-aws-credentials.html#3-destroy-the-compromised-key">3. Destroy the compromised key</a>
          </li>
          <li>
            <a href="/rotate-user-aws-credentials.html#4-let-terraform-create-a-new-key">4. Let terraform create a new key</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/manually-delete-namespace-resources.html#manually-delete-namespace-resources">Manually Delete Namespace Resources</a>
  </li>
</ul>
<ul>
  <li>
    <a href="/delete-live-0-namespace-resources.html#delete-live-0-namespace-resources">Delete Live-0 Namespace Resources</a>
    <ul>
      <li>
        <a href="/delete-live-0-namespace-resources.html#live-0-delete-script-branch">live-0-delete-script branch</a>
      </li>
      <li>
        <a href="/delete-live-0-namespace-resources.html#delete-live-0-namespace-resources-process">Process</a>
        <ul>
          <li>
            <a href="/delete-live-0-namespace-resources.html#deleting-a-production-namespace">Deleting a Production Namespace</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/error-refreshing-state.html#terraform-state-lock-error-refreshing-state">Terraform state lock - Error refreshing state</a>
  </li>
</ul>
<ul>
  <li>
    <a href="/remove-orphaned-namespace.html#remove-39-orphaned-39-namespaces-and-aws-resources">Remove ‘orphaned’ namespaces and AWS resources</a>
    <ul>
      <li>
        <ul>
          <li>
            <a href="/remove-orphaned-namespace.html#1-git-clone-the-environments-checker-repository">1. git clone the environments checker repository</a>
          </li>
          <li>
            <a href="/remove-orphaned-namespace.html#2-create-a-env-live1-file-containing-the-environment-variables-the-checker-requires">2. Create a .env.live1 file, containing the environment variables the checker requires</a>
          </li>
          <li>
            <a href="/remove-orphaned-namespace.html#3-do-a-dry-run-of-deleting-the-target-namespace">3. Do a dry run of deleting the target namespace</a>
          </li>
          <li>
            <a href="/remove-orphaned-namespace.html#4-delete-the-aws-resources-and-the-cluster-namespace">4. Delete the AWS resources and the cluster namespace</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/remove-orphaned-namespace.html#possible-errors">Possible Errors</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/replacing-master-node.html#replacing-a-master-node">Replacing a master node</a>
    <ul>
      <li>
        <a href="/replacing-master-node.html#pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/replacing-master-node.html#identify-the-failed-master-node">Identify the failed master node</a>
      </li>
      <li>
        <a href="/replacing-master-node.html#remove-the-unhealthy-master-node">Remove the unhealthy master node.</a>
      </li>
      <li>
        <a href="/replacing-master-node.html#replacing-the-master-via-kops">Replacing the master via kops</a>
      </li>
      <li>
        <a href="/replacing-master-node.html#etcd-volumes">etcd volumes</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/recycle-node.html#recycle-node">Recycle-node</a>
    <ul>
      <li>
        <a href="/recycle-node.html#guidance-for-cloud-platform-team-when-recycle-node-pipeline-job-fails">Guidance for cloud-platform team, when recycle-node pipeline job fails:</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/post-migration.html#post-migration-cleanup">Post migration cleanup</a>
    <ul>
      <li>
        <a href="/post-migration.html#table-of-contents">Table of contents</a>
      </li>
      <li>
        <a href="/post-migration.html#when-to-use-this-document">When to use this document?</a>
      </li>
      <li>
        <a href="/post-migration.html#0-pre-requisites">0 Pre-requisites</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#1-turn-off-template-deploy-monitoring-and-alerting">1 Turn off Template Deploy monitoring and alerting</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#2-archive-the-deployment-repository">2 Archive the deployment repository</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#3-backup-old-template-deploy-data">3 Backup old Template Deploy data</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#4-delete-the-old-cloudformation-stack">4 Delete the old CloudFormation stack</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#5-ensure-removal-of-resources">5 Ensure removal of resources</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#6-ensure-live-service-is-still-functioning">6 Ensure live service is still functioning!</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/expand.html#expanding-persistent-volumes-created-using-statefulsets">Expanding Persistent Volumes created using StatefulSets</a>
  </li>
</ul>
<ul>
  <li>
    <a href="/running-kops-update-rollingupdate.html#running-kops-update-and-rollingupdate">Running Kops Update and Rollingupdate</a>
    <ul>
      <li>
        <a href="/running-kops-update-rollingupdate.html#using-kops-to-change-the-cluster">Using kops to change the cluster</a>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#running-kops-update-and-rollingupdate-pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#updating-the-kops-state">Updating the kops state</a>
        <ul>
          <li>
            <a href="/running-kops-update-rollingupdate.html#generating-an-updated-kops-config-file">Generating an updated kops config file</a>
          </li>
          <li>
            <a href="/running-kops-update-rollingupdate.html#applying-local-changes-to-the-kops-state-store">Applying local changes to the kops state store</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#running-kops-update">Running Kops update</a>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#running-kops-rolling-update">Running Kops rolling-update</a>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#running-kops-update-and-rollingupdate-possible-errors">Possible Errors</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-new-opa-policy.html#open-policy-agent-policies">Open Policy Agent policies</a>
    <ul>
      <li>
        <a href="/add-new-opa-policy.html#adding-a-policy">Adding a policy</a>
      </li>
      <li>
        <a href="/add-new-opa-policy.html#writing-tests">Writing tests</a>
      </li>
      <li>
        <a href="/add-new-opa-policy.html#references">References</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/joiners-guide.html#joiners-guide">Joiners Guide</a>
    <ul>
      <li>
        <a href="/joiners-guide.html#people-team">People Team</a>
      </li>
      <li>
        <a href="/joiners-guide.html#service-desk">Service Desk</a>
      </li>
      <li>
        <a href="/joiners-guide.html#sit-down-with-dm">SIT down with DM</a>
      </li>
      <li>
        <a href="/joiners-guide.html#cloud-platform-team">Cloud Platform team</a>
      </li>
      <li>
        <a href="/joiners-guide.html#access">ACCESS</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/leavers-guide.html#leavers-guide">Leavers Guide</a>
    <ul>
      <li>
        <a href="/leavers-guide.html#revoking-access">Revoking Access</a>
        <ul>
          <li>
            <a href="/leavers-guide.html#digital-services">Digital Services</a>
          </li>
          <li>
            <a href="/leavers-guide.html#cloud-platforms">Cloud Platforms</a>
          </li>
          <li>
            <a href="/leavers-guide.html#template-deploy-cloud-platforms">Template Deploy - Cloud Platforms</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/on-call.html#going-on-call">Going on call</a>
    <ul>
      <li>
        <a href="/on-call.html#what-s-expected">What’s expected?</a>
        <ul>
          <li>
            <a href="/on-call.html#expected">Expected:</a>
          </li>
          <li>
            <a href="/on-call.html#not-expected">Not Expected:</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/on-call.html#where-do-i-start">Where do I start?</a>
      </li>
      <li>
        <a href="/on-call.html#what-do-i-get-for-being-on-call">What do I get for being on call?</a>
      </li>
      <li>
        <a href="/on-call.html#civil-servants-sop-claim">Civil servants - SOP Claim</a>
      </li>
      <li>
        <a href="/on-call.html#civil-servants-sop-problem-resolution">Civil servants - SOP Problem Resolution</a>
      </li>
      <li>
        <a href="/on-call.html#contractors">Contractors</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/manual-ssl-certificate-processes.html#create-manual-ssl-certificate-processes">Create Manual SSL Certificate Processes</a>
    <ul>
      <li>
        <a href="/manual-ssl-certificate-processes.html#create-manual-ssl-certificate-processes-pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/manual-ssl-certificate-processes.html#requesting-a-new-certificate-via-gandi-net">Requesting a new certificate via Gandi.net</a>
      </li>
      <li>
        <a href="/manual-ssl-certificate-processes.html#renewing-a-new-certificate-via-gandi-net">Renewing a new certificate via Gandi.net</a>
      </li>
      <li>
        <a href="/manual-ssl-certificate-processes.html#revoking-gandi-net-certificates">Revoking Gandi.net certificates</a>
      </li>
      <li>
        <a href="/manual-ssl-certificate-processes.html#costs-funding-information">Costs/Funding information</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/os-places-api-key-management.html#os-places-api-key-management">OS Places API Key Management</a>
    <ul>
      <li>
        <a href="/os-places-api-key-management.html#os-places-api-key-management-pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/os-places-api-key-management.html#creating-a-new-api-key">Creating a new API key</a>
      </li>
      <li>
        <a href="/os-places-api-key-management.html#revoking-an-api-key">Revoking an API key</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/template-deploy-run-books.html#template-deploy-runbooks">Template-deploy Runbooks</a>
    <ul>
      <li>
        <a href="/template-deploy-run-books.html#general-incident-procedure">General Incident Procedure</a>
      </li>
      <li>
        <a href="/template-deploy-run-books.html#existing-runbooks">Existing Runbooks</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/tips-and-tricks.html#tips-and-tricks">Tips and Tricks</a>
    <ul>
      <li>
        <a href="/tips-and-tricks.html#check-the-expiration-date-of-the-ssl-certificate-for-a-live-domain">Check the expiration date of the SSL certificate for a live domain</a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#run-etcdctl-on-a-master-node">Run etcdctl on a master node</a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#delete-a-quot-stuck-quot-resource">Delete a “stuck” resource</a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#filter-namespaces-by-specific-label-or-annotation">Filter namespaces by specific label or annotation</a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#find-all-pods-running-on-a-specific-worker-node">Find all pods running on a specific worker node</a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#install-tmux-and-docker-on-the-live-1-bastion-host">Install tmux and docker on the live-1 bastion host</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-a-new-runbook.html#add-a-new-runbook">Add a new runbook</a>
    <ul>
      <li>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <h1 id="replacing-a-master-node">Replacing a master node</h1><p>If one of the master nodes fails due to hardware failure, data directory corruption, etcd volume deletion, or some other problem, it should be replaced as soon as possible.</p>
<p>To replace the Master node, follow the instructions below for removing the unhealthy member from the cluster, and then re-adding the master node and its volumes via kops</p>
<h2 id="pre-requisites">Pre-requisites</h2><p>Before you begin, there are a few pre-reqs:</p>

<ul>
<li>You are targeting the right cluster.</li>
</ul>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span>kubectl config current-context
</code></pre></div><p>Expected outcome example: <code>live-1.cloud-platform.service.justice.gov.uk</code></p>

<ul>
<li>You are using the right AWS_PROFILE for this cluster.</li>
</ul>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">export </span><span class="nv">AWS_PROFILE</span><span class="o">=</span>moj-cp
</code></pre></div>
<ul>
<li>Export KOPS_STATE_STORE</li>
</ul>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">export </span><span class="nv">KOPS_STATE_STORE</span><span class="o">=</span>s3://cloud-platform-kops-state
</code></pre></div><h2 id="identify-the-failed-master-node">Identify the failed master node</h2><p>Run kops validate cluster to identify failed master node.</p>
<div class="highlight"><pre class="highlight shell"><code>kops validate cluster <span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span>.cloud-platform.service.justice.gov.uk
</code></pre></div><p>You will see validation errors as below, which shows that one of the machines not joined the cluster. Make sure it is a master node by looking for the Instance ID, which should be named as <code>master-&lt;availability-zone&gt;.masters.&lt;cluster_name&gt;.cloud-platform.service.justice.gov.uk</code> in the Amazon EC2 console, on the Instances page.</p>
<div class="highlight"><pre class="highlight shell"><code>VALIDATION ERRORS
KIND    NAME            MESSAGE
Machine i-046ed8d94d65719a6 machine <span class="s2">"i-046ed8d94d65719a6"</span> has not yet joined cluster
</code></pre></div><h2 id="remove-the-unhealthy-master-node">Remove the unhealthy master node.</h2><p>As per <a href="https://github.com/etcd-io/etcd/blob/master/Documentation/faq.md#should-i-add-a-member-before-removing-an-unhealthy-member">this guidance</a> remove the unhealthy member first. Identify and remove the unhealthy member by accessing any of the working master nodes using SSH, via the bastion instance.</p>
<p>In the Amazon EC2 console, on the Instances page, search using <code>${CLUSTER_NAME}</code>to locate bastion instance (<code>bastion.&lt;cluster_name&gt;.cloud-platform.service.justice.gov.uk</code>). Use Public DNS (IPv4) In the description of the Instance to login in to bastion as below:</p>
<div class="highlight"><pre class="highlight shell"><code>ssh <span class="nt">-A</span> admin@ec2-35-176-xx-xx.eu-west-2.compute.amazonaws.com <span class="nt">-p</span> 50422
</code></pre></div><p>From the bastion, login to any of the working master nodes:</p>
<div class="highlight"><pre class="highlight shell"><code>ssh 172.20.xx.xx
</code></pre></div><p>While SSHed onto a master:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>etcd.manager
</code></pre></div><p>You will see output as below:</p>
<div class="highlight"><pre class="highlight plaintext"><code>e81b4622417b  kopeio/etcd-manager         k8s_etcd-manager_etcd-manager-main-...
39c186fba5ea  kopeio/etcd-manager         k8s_etcd-manager_etcd-manager-events-...
8c77d710ce46  k8s.gcr.io/pause-amd64:3.0  k8s_POD_etcd-manager-main-...
806e5af8125d  k8s.gcr.io/pause-amd64:3.0  k8s_POD_etcd-manager-events-...
</code></pre></div><p>Pick the kopeio/etcd-manager container you&rsquo;re interested in (&lsquo;main&rsquo; or &#39;events&rsquo;) and then docker exec onto it</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">sudo </span>docker <span class="nb">exec</span> <span class="nt">-it</span> <span class="o">[</span>container id] bash
</code></pre></div><p>Run etcdctl like this to get the member list of <code>etcd-main</code>. Change the <code>PORT=4002</code> and <code>ETCD=etcd-events</code> and run it again to get the member list of <code>etcd-events</code></p>
<div class="highlight"><pre class="highlight shell"><code><span class="nb">cd</span> /opt/etcd-v3.3.10-linux-amd64/
<span class="nv">CLUSTER</span><span class="o">=</span>live-1
<span class="nv">PORT</span><span class="o">=</span>4001
<span class="nv">ETCD</span><span class="o">=</span>etcd
<span class="nv">ETCDCTL_API</span><span class="o">=</span>3 <span class="se">\</span>
  ./etcdctl <span class="nt">--key</span> /rootfs/etc/kubernetes/pki/kube-apiserver/etcd-client.key <span class="se">\</span>
  <span class="nt">--cert</span>  /rootfs/etc/kubernetes/pki/kube-apiserver/etcd-client.crt <span class="se">\</span>
  <span class="nt">--cacert</span> /rootfs/etc/kubernetes/pki/kube-apiserver/etcd-ca.crt  <span class="se">\</span>
  <span class="nt">--endpoints</span> <span class="s2">"https://</span><span class="k">${</span><span class="nv">ETCD</span><span class="k">}</span><span class="s2">-a.internal.</span><span class="k">${</span><span class="nv">CLUSTER</span><span class="k">}</span><span class="s2">.cloud-platform.service.justice.gov.uk:</span><span class="k">${</span><span class="nv">PORT</span><span class="k">}</span><span class="s2">,https://</span><span class="k">${</span><span class="nv">ETCD</span><span class="k">}</span><span class="s2">-b.internal.</span><span class="k">${</span><span class="nv">CLUSTER</span><span class="k">}</span><span class="s2">.cloud-platform.service.justice.gov.uk:</span><span class="k">${</span><span class="nv">PORT</span><span class="k">}</span><span class="s2">,https://</span><span class="k">${</span><span class="nv">ETCD</span><span class="k">}</span><span class="s2">-c.internal.</span><span class="k">${</span><span class="nv">CLUSTER</span><span class="k">}</span><span class="s2">.cloud-platform.service.justice.gov.uk:</span><span class="k">${</span><span class="nv">PORT</span><span class="k">}</span><span class="s2">"</span> member list
</code></pre></div><p>You will see list of members like this:</p>
<div class="highlight"><pre class="highlight plaintext"><code>26153d5a331dc13d, started, etcd-a, https://etcd-a.internal.test-etcd-1.cloud-platform.service.justice.gov.uk:2380, https://etcd-a.internal.test-etcd-1.cloud-platform.service.justice.gov.uk:4001
27aaafc750f8d2f7, started, etcd-c, https://etcd-c.internal.test-etcd-1.cloud-platform.service.justice.gov.uk:2380, https://etcd-c.internal.test-etcd-1.cloud-platform.service.justice.gov.uk:4001
8d4a23328d324c94, started, etcd-b, https://etcd-b.internal.test-etcd-1.cloud-platform.service.justice.gov.uk:2380, https://etcd-b.internal.test-etcd-1.cloud-platform.service.justice.gov.uk:4001
</code></pre></div><p>The first value in each line is the ID of the member. We will need this to remove the member from the etcd cluster.</p>
<p>Identify the unhealthy member (the old master node) and run the command below to remove the member.</p>
<p>Kops maintains a separate etcd cluster for events, so we need to remove the old node from the etcd-events cluster as well. Change the <code>PORT=4002</code> and <code>ETCD=etcd-events</code> and run it again to remove the old member from the events etcd cluster.</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nb">cd</span> /opt/etcd-v3.3.10-linux-amd64/
<span class="nv">CLUSTER</span><span class="o">=</span>live-1
<span class="nv">PORT</span><span class="o">=</span>4001
<span class="nv">ETCD</span><span class="o">=</span>etcd
<span class="nv">ETCDCTL_API</span><span class="o">=</span>3 <span class="se">\</span>
  ./etcdctl <span class="nt">--key</span> /rootfs/etc/kubernetes/pki/kube-apiserver/etcd-client.key <span class="se">\</span>
  <span class="nt">--cert</span>  /rootfs/etc/kubernetes/pki/kube-apiserver/etcd-client.crt <span class="se">\</span>
  <span class="nt">--cacert</span> /rootfs/etc/kubernetes/pki/kube-apiserver/etcd-ca.crt  <span class="se">\</span>
  <span class="nt">--endpoints</span> <span class="s2">"https://</span><span class="k">${</span><span class="nv">ETCD</span><span class="k">}</span><span class="s2">-a.internal.</span><span class="k">${</span><span class="nv">CLUSTER</span><span class="k">}</span><span class="s2">.cloud-platform.service.justice.gov.uk:</span><span class="k">${</span><span class="nv">PORT</span><span class="k">}</span><span class="s2">,https://</span><span class="k">${</span><span class="nv">ETCD</span><span class="k">}</span><span class="s2">-b.internal.</span><span class="k">${</span><span class="nv">CLUSTER</span><span class="k">}</span><span class="s2">.cloud-platform.service.justice.gov.uk:</span><span class="k">${</span><span class="nv">PORT</span><span class="k">}</span><span class="s2">,https://</span><span class="k">${</span><span class="nv">ETCD</span><span class="k">}</span><span class="s2">-c.internal.</span><span class="k">${</span><span class="nv">CLUSTER</span><span class="k">}</span><span class="s2">.cloud-platform.service.justice.gov.uk:</span><span class="k">${</span><span class="nv">PORT</span><span class="k">}</span><span class="s2">"</span> member remove &lt;member-id&gt;
</code></pre></div><p>You will get a message:</p>
<div class="highlight"><pre class="highlight plaintext"><code>Member 26153d5a331dc13d removed from cluster bdfd883e2bfa8594
</code></pre></div><p>Run the member list again and you will see the member has been removed:</p>
<div class="highlight"><pre class="highlight plaintext"><code>27aaafc750f8d2f7, started, etcd-c, https://etcd-c.internal.test-etcd-1.cloud-platform.service.justice.gov.uk:2380, https://etcd-c.internal.test-etcd-1.cloud-platform.service.justice.gov.uk:4001
8d4a23328d324c94, started, etcd-b, https://etcd-b.internal.test-etcd-1.cloud-platform.service.justice.gov.uk:2380, https://etcd-b.internal.test-etcd-1.cloud-platform.service.justice.gov.uk:4001
</code></pre></div><h2 id="replacing-the-master-via-kops">Replacing the master via kops</h2><p>To be sure that everything runs smoothly and is setup correctly, you need to terminate the broken master and remove the volumes attached to it, and launch the new master with kops.</p>
<p>1) Back up volumes for both etcd main and events by creating snapshots from AWS console.</p>
<p>2) Take a etcdctl <a href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/recovery.md#snapshotting-the-keyspace">backup</a>, by docker exec onto kopeio/etcd-manager container in any of the working master nodes and run the below command.</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nb">cd</span> /opt/etcd-v3.3.10-linux-amd64/
<span class="nv">CLUSTER</span><span class="o">=</span>live-1
<span class="nv">PORT</span><span class="o">=</span>4001
<span class="nv">ETCD</span><span class="o">=</span>etcd
<span class="nv">ETCDCTL_API</span><span class="o">=</span>3 <span class="se">\</span>
  ./etcdctl <span class="nt">--key</span> /rootfs/etc/kubernetes/pki/kube-apiserver/etcd-client.key <span class="se">\</span>
  <span class="nt">--cert</span>  /rootfs/etc/kubernetes/pki/kube-apiserver/etcd-client.crt <span class="se">\</span>
  <span class="nt">--cacert</span> /rootfs/etc/kubernetes/pki/kube-apiserver/etcd-ca.crt  <span class="se">\</span>
  <span class="nt">--endpoints</span> <span class="s2">"https://</span><span class="k">${</span><span class="nv">ETCD</span><span class="k">}</span><span class="s2">-a.internal.</span><span class="k">${</span><span class="nv">CLUSTER</span><span class="k">}</span><span class="s2">.cloud-platform.service.justice.gov.uk:</span><span class="k">${</span><span class="nv">PORT</span><span class="k">}</span><span class="s2">,https://</span><span class="k">${</span><span class="nv">ETCD</span><span class="k">}</span><span class="s2">-b.internal.</span><span class="k">${</span><span class="nv">CLUSTER</span><span class="k">}</span><span class="s2">.cloud-platform.service.justice.gov.uk:</span><span class="k">${</span><span class="nv">PORT</span><span class="k">}</span><span class="s2">,https://</span><span class="k">${</span><span class="nv">ETCD</span><span class="k">}</span><span class="s2">-c.internal.</span><span class="k">${</span><span class="nv">CLUSTER</span><span class="k">}</span><span class="s2">.cloud-platform.service.justice.gov.uk:</span><span class="k">${</span><span class="nv">PORT</span><span class="k">}</span><span class="s2">"</span> snapshot save /rootfs/mnt/snapshot.db
</code></pre></div><p>You will get a message as below. The snapshot.db is saved at <code>/rootfs/mnt/</code>, which is volume mounted to a local directory at <code>/mnt</code>.</p>
<div class="highlight"><pre class="highlight plaintext"><code>Snapshot saved at /rootfs/mnt/snapshot.db
</code></pre></div><p>3) Edit the kops instance group for the master you removed, to scale down by replacing maxSize and minSize values to 0, and run an kops update on the cluster.</p>
<div class="highlight"><pre class="highlight plaintext"><code>kops edit instancegroup master-eu-west-2a
</code></pre></div><div class="highlight"><pre class="highlight shell"><code>kops update cluster <span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span>.cloud-platform.service.justice.gov.uk <span class="nt">--yes</span>
</code></pre></div><p>4) In the Amazon EC2 console, on the Instances page, search using <code>${CLUSTER_NAME}</code> to locate broken master instance (<code>master-&lt;availability-zone&gt;.masters.&lt;cluster_name&gt;.cloud-platform.service.justice.gov.uk</code>). Terminate the broken master instance following this <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/terminating-instances.html">guide</a>.</p>
<p>5) In the Amazon volume console, search using <code>${CLUSTER_NAME}</code> to locate the right volume associated with the broken master. Remove volumes (main and events) for the broken master.</p>
<p>For example, volumes will be named as below, for master <code>master-eu-west-2a.masters.live-1.cloud-platform.service.justice.gov.uk</code>.</p>
<div class="highlight"><pre class="highlight plaintext"><code>a.etcd-main.live-1.cloud-platform.service.justice.gov.uk
a.etcd-events.live-1.cloud-platform.service.justice.gov.uk
</code></pre></div><p>6) Create the master instance with kops.</p>
<p>Edit the kops instancegroup, and scale back up by changing maxSize and minSize values to 1, then run a kops update on the cluster.</p>
<div class="highlight"><pre class="highlight plaintext"><code>kops edit instancegroup master-eu-west-2a
</code></pre></div><div class="highlight"><pre class="highlight shell"><code>kops update cluster <span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span>.cloud-platform.service.justice.gov.uk <span class="nt">--yes</span>
</code></pre></div><p>Master will be restarted with a clean config and should join the others. Give some time (10-15 min) and validate the cluster, the replacement master node should join the cluster and be in ready status.</p>
<div class="highlight"><pre class="highlight shell"><code>kops validate cluster <span class="k">${</span><span class="nv">CLUSTER_NAME</span><span class="k">}</span>.cloud-platform.service.justice.gov.uk
</code></pre></div><p>You can see the cluster is in ready status.</p>
<div class="highlight"><pre class="highlight plaintext"><code>Your cluster ${CLUSTER_NAME}.cloud-platform.service.justice.gov.uk is ready
</code></pre></div><h2 id="etcd-volumes">etcd volumes</h2><p>Kubernetes live-1 cluster deployed with kops stores the etcd state in two different AWS EBS volumes per master node. One volume is used to store the Kubernetes main data, the other one for events. For a cluster with three masters this will result in six volumes for etcd data (one in each AZ).</p>


              <div data-module='page-expiry' data-last-reviewed-on="2019-12-10">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 10 September 2019.

        It needs to be reviewed again on 10 December 2019
        by the page owner <a href="https://mojdt.slack.com/messages/cloud-platform">#cloud-platform</a>
        .
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 10 December 2019
       by the page owner <a href="https://mojdt.slack.com/messages/cloud-platform">#cloud-platform</a>.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

            <ul class="contribution-banner">
              <li><a href="https://github.com/ministryofjustice/cloud-platform/blob/master/source/replacing-master-node.html.md.erb">View source</a></li>
              <li><a href="https://github.com/ministryofjustice/cloud-platform/issues/new?labels=bug&amp;title=Re:%20'Replacing%20a%20master%20node'&amp;body=Problem%20with%20'Replacing%20a%20master%20node'%20(https://runbooks.cloud-platform.service.justice.gov.uk/replacing-master-node.html)">Report problem</a></li>
              <li><a href="https://github.com/ministryofjustice/cloud-platform">GitHub Repo</a></li>
            </ul>

          <footer class="footer">
  <div class="footer__licence">
    <a class="footer__licence-logo" href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence</a>
    <p class="footer__licence-description">All content is available under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence v3.0</a>, except where otherwise stated</p>
  </div>

  <div class="footer__copyright">
    <a class="footer__copyright-logo" href="http://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/copyright-and-re-use/crown-copyright/">© Crown copyright</a>
  </div>
</footer>

        </div>
      </div>
    </div>

    
  </body>
</html>
