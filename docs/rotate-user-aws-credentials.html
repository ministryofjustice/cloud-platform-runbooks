<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
      <meta name="robots" content="noindex">

    <title>Rotate User AWS Credentials | Cloud Platform Runbooks</title>

    <!--[if gt IE 8]><!--><link href="/stylesheets/screen.css" rel="stylesheet" media="screen" /><!--<![endif]-->
    <!--[if lte IE 8]><link href="/stylesheets/screen-old-ie.css" rel="stylesheet" media="screen" /><![endif]-->

    <link rel="canonical" href="https://runbooks.cloud-platform.service.justice.gov.uk/rotate-user-aws-credentials.html">


    <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
    <script src="/javascripts/application.js"></script>

      <meta property="og:image" content="https://runbooks.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="Cloud Platform Runbooks" />
      <meta property="og:title" content="Rotate User AWS Credentials" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://runbooks.cloud-platform.service.justice.gov.uk/rotate-user-aws-credentials.html" />
      <meta property="twitter:card" content="summary" />
      <meta property="twitter:domain" content="runbooks.cloud-platform.service.justice.gov.uk" />
      <meta property="twitter:image" content="https://runbooks.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="twitter:title" content="Rotate User AWS Credentials | Cloud Platform Runbooks" />
      <meta property="twitter:url" content="https://runbooks.cloud-platform.service.justice.gov.uk/rotate-user-aws-credentials.html" />

    
  </head>

  <body>
    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="skip-link">Skip to main content</a>

        <header class="header header--full-width">
  <div class="header__container">
    <div class="header__brand">
        <a href="/">
        <span class="header__title">
          Cloud Platform Runbooks
            <span class="phase-banner">INTERNAL</span>
        </span>
        </a>
    </div>

      <div data-module="navigation">
        <button type="button" class="header__navigation-toggle js-nav-toggle" aria-controls="navigation" aria-label="Show or hide top level navigation">Menu</button>

        <nav id="navigation" class="header__navigation js-nav" aria-label="Top Level Navigation" aria-hidden="true">
          <ul>
              <li>
                <a href="mailto:platforms+runbooks@digital.justice.gov.uk?subject=Runbooks+feedback">Feedback / Report a problem</a>
              </li>
              <li>
                <a href="/">Documentation</a>
              </li>
              <li>
                <a href="https://github.com/ministryofjustice/cloud-platform/tree/master/runbooks">GitHub</a>
              </li>
          </ul>
        </nav>
      </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search">
    <input type="hidden" name="as_sitesearch" value="https://runbooks.cloud-platform.service.justice.gov.uk"/>
    <label for="search"  class="search__label">Search (via Google)</label>
    <input type="text" id="search" name="q" placeholder="Search" aria-controls="search-results" class="form-control" />
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="polite">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading" data-module="collapsible-navigation">
                      <ul>
  <li>
    <a href="/#cloud-platform-runbooks">Cloud Platform Runbooks</a>
  </li>
</ul>
<ul>
  <li>
    <a href="/create-cluster.html#create-a-new-cluster">Create a new cluster</a>
    <ul>
      <li>
        <a href="/create-cluster.html#pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/create-cluster.html#environment-variables">Environment Variables</a>
      </li>
      <li>
        <a href="/create-cluster.html#run-the-build-script-via-the-tools-image">Run the build script, via the tools image</a>
      </li>
      <li>
        <a href="/create-cluster.html#disable-alerts">Disable Alerts</a>
        <ul>
          <li>
            <a href="/create-cluster.html#high-priority-alerts">High Priority Alerts</a>
          </li>
          <li>
            <a href="/create-cluster.html#lower-priority-alerts">Lower priority alerts</a>
          </li>
          <li>
            <a href="/create-cluster.html#apply-the-changes">Apply the changes</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/delete-cluster.html#delete-a-cluster">Delete a cluster</a>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-nodes-to-the-cluster.html#add-nodes-to-the-cluster">Add nodes to the cluster</a>
    <ul>
      <li>
        <ul>
          <li>
            <a href="/add-nodes-to-the-cluster.html#requirements">Requirements</a>
          </li>
          <li>
            <a href="/add-nodes-to-the-cluster.html#inline-edit">Inline edit</a>
          </li>
          <li>
            <a href="/add-nodes-to-the-cluster.html#persisting-the-changes">Persisting the changes</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/rotate-git-crypt-key.html#rotating-the-git-crypt-key">Rotating the git-crypt key</a>
    <ul>
      <li>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/disaster-recovery.html#cloud-platform-disaster-recovery">Cloud Platform Disaster Recovery</a>
    <ul>
      <li>
        <a href="/disaster-recovery.html#restore-process">Restore process</a>
      </li>
      <li>
        <a href="/disaster-recovery.html#apply-cloud-platform-resources">Apply cloud-platform resources</a>
      </li>
      <li>
        <a href="/disaster-recovery.html#cloud-platform-disaster-recovery-create-a-new-cluster">Create a new cluster</a>
      </li>
      <li>
        <a href="/disaster-recovery.html#perform-the-restore">Perform the restore</a>
        <ul>
          <li>
            <a href="/disaster-recovery.html#perform-the-restore-pre-requisites">Pre-requisites</a>
          </li>
          <li>
            <a href="/disaster-recovery.html#restore-the-cluster-using-etcd-manager-ctl-on-your-computer">Restore the cluster using etcd-manager-ctl on your computer.</a>
          </li>
          <li>
            <a href="/disaster-recovery.html#restore-process-inside-the-etcd-container-using-etcd-manager-ctl">Restore process inside the etcd container using etcd-manager-ctl.</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/disaster-recovery.html#cleanup">Cleanup</a>
      </li>
      <li>
        <a href="/disaster-recovery.html#possible-issues">Possible Issues</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/rotate-user-aws-credentials.html#rotate-user-aws-credentials">Rotate User AWS Credentials</a>
    <ul>
      <li>
        <ul>
          <li>
          </li>
          <li>
            <a href="/rotate-user-aws-credentials.html#2-identify-the-compromised-terraform-object">2. Identify the compromised terraform object</a>
          </li>
          <li>
            <a href="/rotate-user-aws-credentials.html#3-destroy-the-compromised-key">3. Destroy the compromised key</a>
          </li>
          <li>
            <a href="/rotate-user-aws-credentials.html#4-let-terraform-create-a-new-key">4. Let terraform create a new key</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/remove-orphaned-namespace.html#remove-39-orphaned-39-namespaces-and-aws-resources">Remove ‘orphaned’ namespaces and AWS resources</a>
    <ul>
      <li>
        <ul>
          <li>
            <a href="/remove-orphaned-namespace.html#1-git-clone-the-environments-checker-repository">1. git clone the environments checker repository</a>
          </li>
          <li>
            <a href="/remove-orphaned-namespace.html#2-create-a-env-live1-file-containing-the-environment-variables-the-checker-requires">2. Create a .env.live1 file, containing the environment variables the checker requires</a>
          </li>
          <li>
            <a href="/remove-orphaned-namespace.html#3-do-a-dry-run-of-deleting-the-target-namespace">3. Do a dry run of deleting the target namespace</a>
          </li>
          <li>
            <a href="/remove-orphaned-namespace.html#4-delete-the-aws-resources-and-the-cluster-namespace">4. Delete the AWS resources and the cluster namespace</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/remove-orphaned-namespace.html#possible-errors">Possible Errors</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/replacing-master-node.html#replacing-a-master-node">Replacing a master node</a>
    <ul>
      <li>
        <a href="/replacing-master-node.html#replacing-a-master-node-pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/replacing-master-node.html#identify-the-failed-master-node">Identify the failed master node</a>
      </li>
      <li>
        <a href="/replacing-master-node.html#remove-the-unhealthy-master-node">Remove the unhealthy master node.</a>
      </li>
      <li>
        <a href="/replacing-master-node.html#replacing-the-master-via-kops">Replacing the master via kops</a>
      </li>
      <li>
        <a href="/replacing-master-node.html#etcd-volumes">etcd volumes</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/post-migration.html#post-migration-cleanup">Post migration cleanup</a>
    <ul>
      <li>
        <a href="/post-migration.html#table-of-contents">Table of contents</a>
      </li>
      <li>
        <a href="/post-migration.html#when-to-use-this-document">When to use this document?</a>
      </li>
      <li>
        <a href="/post-migration.html#0-pre-requisites">0 Pre-requisites</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#1-turn-off-template-deploy-monitoring-and-alerting">1 Turn off Template Deploy monitoring and alerting</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#2-archive-the-deployment-repository">2 Archive the deployment repository</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#3-backup-old-template-deploy-data">3 Backup old Template Deploy data</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#4-delete-the-old-cloudformation-stack">4 Delete the old CloudFormation stack</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#5-ensure-removal-of-resources">5 Ensure removal of resources</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#6-ensure-live-service-is-still-functioning">6 Ensure live service is still functioning!</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/expand.html#expanding-persistent-volumes-created-using-statefulsets">Expanding Persistent Volumes created using StatefulSets</a>
  </li>
</ul>
<ul>
  <li>
    <a href="/running-kops-update-rollingupdate.html#running-kops-update-and-rollingupdate">Running Kops Update and Rollingupdate</a>
    <ul>
      <li>
        <a href="/running-kops-update-rollingupdate.html#running-kops-update-and-rollingupdate-pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#running-kops-update">Running Kops update</a>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#running-kops-rolling-update">Running Kops rolling-update</a>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#running-kops-update-and-rollingupdate-possible-errors">Possible Errors</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-new-opa-policy.html#open-policy-agent-policies">Open Policy Agent policies</a>
    <ul>
      <li>
        <a href="/add-new-opa-policy.html#adding-a-policy">Adding a policy</a>
      </li>
      <li>
        <a href="/add-new-opa-policy.html#writing-tests">Writing tests</a>
      </li>
      <li>
        <a href="/add-new-opa-policy.html#references">References</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/leavers-guide.html#leavers-guide">Leavers Guide</a>
    <ul>
      <li>
        <a href="/leavers-guide.html#revoking-access">Revoking Access</a>
        <ul>
          <li>
            <a href="/leavers-guide.html#digital-services">Digital Services</a>
          </li>
          <li>
            <a href="/leavers-guide.html#cloud-platforms">Cloud Platforms</a>
          </li>
          <li>
            <a href="/leavers-guide.html#template-deploy-cloud-platforms">Template Deploy - Cloud Platforms</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/on-call.html#going-on-call">Going on call</a>
    <ul>
      <li>
        <a href="/on-call.html#expected">Expected:</a>
      </li>
      <li>
        <a href="/on-call.html#not-expected">Not Expected:</a>
      </li>
      <li>
        <a href="/on-call.html#where-do-i-start">Where do I start?</a>
        <ul>
          <li>
            <a href="/on-call.html#1-do-two-rotations-on-in-hours-second-line">1/ Do two rotations on in-hours second line.</a>
          </li>
          <li>
            <a href="/on-call.html#2-get-production-access-to-supported-services">2/ Get production access to supported services.</a>
          </li>
          <li>
            <a href="/on-call.html#3-get-access-to-our-on-call-tools">3/ Get access to our on-call tools:</a>
          </li>
          <li>
            <a href="/on-call.html#4-do-a-dry-run-of-an-incident">4/ Do a dry-run of an incident.</a>
          </li>
          <li>
            <a href="/on-call.html#5-get-on-the-on-call-rota">5/ Get on the on-call rota.</a>
          </li>
          <li>
            <a href="/on-call.html#6-log-your-hours">6/ Log your hours.</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/on-call.html#what-do-i-get-for-being-on-call">What do I get for being on call?</a>
      </li>
      <li>
        <a href="/on-call.html#civil-servants-sop-claim">Civil servants - SOP Claim</a>
        <ul>
          <li>
            <a href="/on-call.html#1-get-a-dom1-account-you-should-be-given-one-as-soon-as-shared-services-have-registered-your-joining-or-ask-your-local-hr-people">1/ Get a DOM1 account  (you should be given one as soon as Shared Services have registered your joining, or ask your local HR people)</a>
          </li>
          <li>
            <a href="/on-call.html#2-log-into-a-dom1-machine-and-access-sop-using-the-shortcut-on-your-desktop-and-log-in">2/ Log into a DOM1 machine and access SOP using the shortcut on your desktop, and log in.</a>
          </li>
          <li>
            <a href="/on-call.html#3-navigate-to-employee-self-service-gt-individual-compensation-distribution-icd">3/ Navigate to Employee Self-Service > Individual Compensation Distribution (ICD)</a>
          </li>
          <li>
            <a href="/on-call.html#4-select-drop-down-menu-for-on-call-without-pensionable-amount">4/ Select drop-down menu for On-call without pensionable amount</a>
          </li>
          <li>
            <a href="/on-call.html#5-add-the-amount-claimed-for-in-the-box-provided">5/ Add the amount claimed for in the box provided</a>
          </li>
          <li>
            <a href="/on-call.html#6-click-continue-check-the-details-add-notes-in-the-comment-section-about-the-weeks-being-claimed-and-then-click-submit">6/ Click “Continue”, check the details, add notes in the comment section about the weeks being claimed, and then click “Submit”</a>
          </li>
          <li>
            <a href="/on-call.html#7-if-your-claim-is-submitted-before-the-8th-or-so-of-the-month-you-ll-get-it-paid-in-that-month-s-payroll-if-it-s-after-that-it-ll-be-in-the-next-month-s">7/ If your claim is submitted before the 8th (or so) of the month, you’ll get it paid in that month’s payroll. If it’s after that, it’ll be in the next month’s.</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/on-call.html#civil-servants-sop-problem-resolution">Civil servants - SOP Problem Resolution</a>
        <ul>
          <li>
            <a href="/on-call.html#1-take-a-screenshot-of-the-claim-submission-problem">1/ Take a screenshot of the claim submission problem.</a>
          </li>
          <li>
            <a href="/on-call.html#2-navigate-to-employee-self-service-gt-others-gt-form-submission">2/ Navigate to Employee Self-Service > Others > Form Submission</a>
          </li>
          <li>
            <a href="/on-call.html#3-select-problem-area-by-pressing-the-magnifying-glass-icon-and-pressing-go">3/ Select problem area by pressing the magnifying glass icon and pressing “Go”.</a>
          </li>
          <li>
            <a href="/on-call.html#4-add-comments-describing-the-problem">4/ Add comments describing the problem.</a>
          </li>
          <li>
            <a href="/on-call.html#5-after-clicking-next-add-attachment-to-add-the-screenshot-and-click-submit">5/ After clicking “Next”, “Add Attachment” to add the screenshot and click “Submit”</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/on-call.html#contractors">Contractors</a>
        <ul>
          <li>
            <a href="/on-call.html#1-ask-your-contact-at-the-supplier-to-set-you-up-on-fieldglass-for-overtime">1/ Ask your contact at the supplier to set you up on Fieldglass for overtime.</a>
          </li>
          <li>
            <a href="/on-call.html#2-log-your-time">2 /Log your time</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/tips-and-tricks.html#tips-and-tricks">Tips and Tricks</a>
    <ul>
      <li>
        <a href="/tips-and-tricks.html#check-the-expiration-date-of-the-ssl-certificate-for-a-live-domain">Check the expiration date of the SSL certificate for a live domain</a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#run-etcdctl-on-a-master-node">Run etcdctl on a master node</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/template-deploy-run-books.html#template-deploy-runbooks">Template-deploy Runbooks</a>
    <ul>
      <li>
        <a href="/template-deploy-run-books.html#general-incident-procedure">General Incident Procedure</a>
      </li>
      <li>
        <a href="/template-deploy-run-books.html#existing-runbooks">Existing Runbooks</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-a-new-runbook.html#add-a-new-runbook">Add a new runbook</a>
    <ul>
      <li>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <h1 id="rotate-user-aws-credentials">Rotate User AWS Credentials</h1><p>Use this runbook if a user&rsquo;s AWS credentials have been exposed. In this case, &lsquo;AWS credentials&rsquo; refers to credentials created by terraform, for resources in the user&rsquo;s namespace.</p>
<p>We will make terraform destroy the compromised credentials, and then recreate them. For this example, we will use the case where an AWS credential for an ECR in the my-namespace namespace was exposed.</p>
<p><strong>Please amend the code snippets below to match your actual circumstance.</strong></p>
<h4 id="1-prepare-terraform-to-manipulate-the-user-39-s-aws-resources">1. Prepare terraform to manipulate the user&rsquo;s AWS resources</h4><p>You need a working copy of the environments <a href="https://github.com/ministryofjustice/cloud-platform-environments">github repo</a>.</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">cd </span>cloud-platform-environments/namespaces/live-1.cloud-platform.service.justice.gov.uk
<span class="nv">$ </span><span class="nb">cd </span>my-namespace/resources
</code></pre></div><p>Terraform needs AWS credentials to access the state files on S3.</p>
<p>If you have an AWS profile defined for the cloud platform AWS account, you can run:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nb">export </span><span class="nv">AWS_PROFILE</span><span class="o">=[</span>profile name <span class="k">in</span> ~/.aws/credentials]<span class="sb">`</span>
</code></pre></div><p>If not, export the key and secret like this:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=[</span>your access key]
<span class="nv">$ </span><span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=[</span>your secret key]
</code></pre></div><p>Then you should be able to run terraform init, targeting the relevant namespace:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span>terraform init <span class="se">\</span>
  <span class="nt">-backend-config</span><span class="o">=</span><span class="s2">"bucket=cloud-platform-terraform-state"</span> <span class="se">\</span>
  <span class="nt">-backend-config</span><span class="o">=</span><span class="s2">"key=cloud-platform-environments/live-1.cloud-platform.service.justice.gov.uk/my-namespace/terraform.tfstate"</span> <span class="se">\</span>
  <span class="nt">-backend-config</span><span class="o">=</span><span class="s2">"region=eu-west-1"</span> <span class="se">\</span>
  <span class="nt">-backend</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">-get</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">-input</span><span class="o">=</span><span class="nb">false</span>

<span class="nv">$ </span>terraform plan
</code></pre></div><p>The final <code>terraform plan</code> should output <code>No changes. Infrastructure is up-to-date.</code></p>
<h3 id="2-identify-the-compromised-terraform-object">2. Identify the compromised terraform object</h3><div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span>terraform show | less
</code></pre></div><p>Look for the compromised access key. In this case, the access key was AKIA27HJSWAHHIG5ACYA, and it occurs in two places in the output.</p>
<div class="highlight"><pre class="highlight plaintext"><code>...
kubernetes_secret.ecr-repo-my-repo:
  id = my-namespace/ecr-repo-my-repo
  data.% = 3
  data.access_key_id = AKIA27HJSWAHHIG5ACYA
  data.repo_url = ...
  data.secret_access_key = ...
...
module.ecr-repo-my-repo.aws_iam_access_key.key:
  id = AKIA27HJSWAHHIG5ACYA
  secret = ...
  ses_smtp_password = ...
...
</code></pre></div><p>The first occurence is when terraform stores the credentials in a kubernetes secret.</p>
<p>The second occurence is the one we want, where terraform creates the credentials (the <code>aws_iam_access_key.key</code> resource, for the ECR repo).</p>
<h3 id="3-destroy-the-compromised-key">3. Destroy the compromised key</h3><div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span>terraform destroy <span class="nt">--target</span><span class="o">=</span>module.ecr-repo-my-repo.aws_iam_access_key.key
</code></pre></div><p>If this looks like it&rsquo;s going to do the right thing, enter &#39;yes&rsquo; to confirm.</p>
<div class="highlight"><pre class="highlight plaintext"><code>An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  - destroy

Terraform will perform the following actions:

  - module.ecr-repo-my-repo.aws_iam_access_key.key


Plan: 0 to add, 0 to change, 1 to destroy.
</code></pre></div><h3 id="4-let-terraform-create-a-new-key">4. Let terraform create a new key</h3><div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span>terraform plan
</code></pre></div><p>This should report that it will <strong>create</strong> a new <code>aws_iam_access_key.key</code> resource and <strong>modify</strong> the corresponding <code>kubernetes_secret</code> resource.</p>
<div class="highlight"><pre class="highlight plaintext"><code>An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create
  ~ update in-place

Terraform will perform the following actions:

  ~ kubernetes_secret.ecr-repo-my-repo
      data.%:                 "" =&gt; &lt;computed&gt;
      data.access_key_id:     "AKIA27HJSWAHHIG5ACYA" =&gt; ""
      data.repo_url:          "..." =&gt; ""
      data.secret_access_key: "..." =&gt; ""

  + module.ecr-repo-my-repo.aws_iam_access_key.key
      id:                     &lt;computed&gt;
      encrypted_secret:       &lt;computed&gt;
      key_fingerprint:        &lt;computed&gt;
      secret:                 &lt;computed&gt;
      ses_smtp_password:      &lt;computed&gt;
      status:                 &lt;computed&gt;
      user:                   "ecr-user-0000000000000000"


Plan: 1 to add, 1 to change, 0 to destroy.
</code></pre></div><p>If all is well:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span>terraform apply
</code></pre></div><p>If this looks like it&rsquo;s going to do the right thing, enter &#39;yes&rsquo; to confirm.</p>
<p>At this point, a new set of AWS credentials should have been created for the existing IAM user, and the kubernetes secret should contain the new access key and secret.</p>


            
          </main>

            <ul class="contribution-banner">
              <li><a href="https://github.com/ministryofjustice/cloud-platform/blob/master/source/rotate-user-aws-credentials.html.md.erb">View source</a></li>
              <li><a href="https://github.com/ministryofjustice/cloud-platform/issues/new?labels=bug&amp;title=Re:%20'Rotate%20User%20AWS%20Credentials'&amp;body=Problem%20with%20'Rotate%20User%20AWS%20Credentials'%20(https://runbooks.cloud-platform.service.justice.gov.uk/rotate-user-aws-credentials.html)">Report problem</a></li>
              <li><a href="https://github.com/ministryofjustice/cloud-platform">GitHub Repo</a></li>
            </ul>

          <footer class="footer">
  <div class="footer__licence">
    <a class="footer__licence-logo" href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence</a>
    <p class="footer__licence-description">All content is available under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence v3.0</a>, except where otherwise stated</p>
  </div>

  <div class="footer__copyright">
    <a class="footer__copyright-logo" href="http://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/copyright-and-re-use/crown-copyright/">© Crown copyright</a>
  </div>
</footer>

        </div>
      </div>
    </div>

    
  </body>
</html>
