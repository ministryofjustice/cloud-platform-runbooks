<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
      <meta name="robots" content="noindex">

    <title>Guidance when recycle-node pipeline job fails | Cloud Platform Runbooks</title>

    <!--[if gt IE 8]><!--><link href="/stylesheets/screen.css" rel="stylesheet" media="screen" /><!--<![endif]-->
    <!--[if lte IE 8]><link href="/stylesheets/screen-old-ie.css" rel="stylesheet" media="screen" /><![endif]-->

    <link rel="canonical" href="https://runbooks.cloud-platform.service.justice.gov.uk/recycle-node.html">


    <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
    <script src="/javascripts/application.js"></script>

      <meta property="og:image" content="https://runbooks.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="Cloud Platform Runbooks" />
      <meta property="og:title" content="Guidance when recycle-node pipeline job fails" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://runbooks.cloud-platform.service.justice.gov.uk/recycle-node.html" />
      <meta property="twitter:card" content="summary" />
      <meta property="twitter:domain" content="runbooks.cloud-platform.service.justice.gov.uk" />
      <meta property="twitter:image" content="https://runbooks.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="twitter:title" content="Guidance when recycle-node pipeline job fails | Cloud Platform Runbooks" />
      <meta property="twitter:url" content="https://runbooks.cloud-platform.service.justice.gov.uk/recycle-node.html" />

    
  </head>

  <body>
    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="skip-link">Skip to main content</a>

        <header class="header header--full-width">
  <div class="header__container">
    <div class="header__brand">
        <a href="/">
        <span class="header__title">
          Cloud Platform Runbooks
            <span class="phase-banner">INTERNAL</span>
        </span>
        </a>
    </div>

      <div data-module="navigation">
        <button type="button" class="header__navigation-toggle js-nav-toggle" aria-controls="navigation" aria-label="Show or hide top level navigation">Menu</button>

        <nav id="navigation" class="header__navigation js-nav" aria-label="Top Level Navigation" aria-hidden="true">
          <ul>
              <li>
                <a href="mailto:platforms+runbooks@digital.justice.gov.uk?subject=Runbooks+feedback">Feedback / Report a problem</a>
              </li>
              <li>
                <a href="/">Documentation</a>
              </li>
              <li>
                <a href="https://github.com/ministryofjustice/cloud-platform/tree/master/runbooks">GitHub</a>
              </li>
          </ul>
        </nav>
      </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search">
    <input type="hidden" name="as_sitesearch" value="https://runbooks.cloud-platform.service.justice.gov.uk"/>
    <label for="search"  class="search__label">Search (via Google)</label>
    <input type="text" id="search" name="q" placeholder="Search" aria-controls="search-results" class="form-control" />
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="polite">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading" data-module="collapsible-navigation">
                      <ul>
  <li>
    <a href="/#cloud-platform-runbooks">Cloud Platform Runbooks</a>
  </li>
</ul>
<ul>
  <li>
    <a href="/incident-process.html#incident-process">Incident Process</a>
    <ul>
      <li>
        <a href="/incident-process.html#1-confirm-that-the-event-constitutes-an-incident">1. Confirm that the event constitutes an incident</a>
      </li>
      <li>
        <a href="/incident-process.html#2-declare-the-incident">2. Declare the incident</a>
        <ul>
          <li>
            <a href="/incident-process.html#examples">Examples</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/incident-process.html#3-assign-roles">3. Assign roles</a>
        <ul>
          <li>
            <a href="/incident-process.html#3-1-incident-lead">3.1 Incident Lead</a>
          </li>
          <li>
            <a href="/incident-process.html#3-2-scribe">3.2 Scribe</a>
          </li>
          <li>
            <a href="/incident-process.html#3-3-communications-lead">3.3 Communications Lead</a>
          </li>
          <li>
            <a href="/incident-process.html#transferring-roles">Transferring roles</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/incident-process.html#4-fix-the-problem">4. Fix the problem</a>
      </li>
      <li>
        <a href="/incident-process.html#5-end-the-incident">5. End the incident</a>
      </li>
      <li>
        <a href="/incident-process.html#6-post-incident-procedure">6. Post-incident procedure</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/incident-log.html#incident-log">Incident Log</a>
    <ul>
      <li>
        <a href="/incident-log.html#february-2020">February 2020</a>
        <ul>
          <li>
            <a href="/incident-log.html#incident-on-2020-02-25-10-58-utc">Incident on 2020-02-25 10:58 UTC</a>
          </li>
          <li>
            <a href="/incident-log.html#incident-on-2020-02-18-14-13-utc">Incident on 2020-02-18 14:13 UTC</a>
          </li>
          <li>
            <a href="/incident-log.html#incident-on-2020-02-12-11-45-utc">Incident on 2020-02-12 11:45 UTC</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/create-cluster.html#create-a-new-cluster">Create a new cluster</a>
    <ul>
      <li>
        <a href="/create-cluster.html#pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/create-cluster.html#environment-variables">Environment Variables</a>
      </li>
      <li>
        <a href="/create-cluster.html#run-the-build-script-via-the-tools-image">Run the build script, via the tools image</a>
      </li>
      <li>
        <a href="/create-cluster.html#alerts">Alerts</a>
        <ul>
          <li>
            <a href="/create-cluster.html#apply-the-changes">Apply the changes</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-concourse-to-cluster.html#add-concourse-to-a-test-cluster">Add Concourse to a test cluster</a>
    <ul>
      <li>
        <a href="/add-concourse-to-cluster.html#add-concourse-to-a-test-cluster-pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/add-concourse-to-cluster.html#process">Process</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/upgrade-cluster.html#upgrade-a-cluster">Upgrade a cluster</a>
    <ul>
      <li>
        <a href="/upgrade-cluster.html#upgrade-a-cluster-pre-requisites">Pre-requisites</a>
        <ul>
          <li>
            <a href="/upgrade-cluster.html#upgrade-a-cluster-pre-requisites-environment-variables">Environment Variables</a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#sanity-checks">Sanity checks</a>
          </li>
          <li>
            <a href="/upgrade-cluster.html#run-a-shell-in-the-tools-image">Run a shell in the tools image</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/upgrade-cluster.html#run-the-upgrade">Run the upgrade</a>
      </li>
      <li>
        <a href="/upgrade-cluster.html#upgrade-a-cluster-sanity-checks">Sanity checks</a>
      </li>
      <li>
        <a href="/upgrade-cluster.html#commit">Commit</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/delete-cluster.html#delete-a-cluster">Delete a cluster</a>
    <ul>
      <li>
        <a href="/delete-cluster.html#delete-the-cluster-using-the-script">Delete the cluster using the script</a>
      </li>
      <li>
        <a href="/delete-cluster.html#delete-the-cluster-manually">Delete the cluster manually</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-nodes-to-the-cluster.html#add-nodes-to-the-cluster">Add nodes to the cluster</a>
    <ul>
      <li>
        <ul>
          <li>
            <a href="/add-nodes-to-the-cluster.html#requirements">Requirements</a>
          </li>
          <li>
            <a href="/add-nodes-to-the-cluster.html#inline-edit">Inline edit</a>
          </li>
          <li>
            <a href="/add-nodes-to-the-cluster.html#persisting-the-changes">Persisting the changes</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/rotate-git-crypt-key.html#git-crypt">Git-crypt</a>
    <ul>
      <li>
        <a href="/rotate-git-crypt-key.html#adding-new-user-to-the-keyring">Adding new user to the keyring</a>
      </li>
      <li>
        <a href="/rotate-git-crypt-key.html#rotating-the-git-crypt-key">Rotating the git-crypt key</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-new-receiver-alert-manager.html#add-a-new-alertmanager-receiver-and-a-slack-webhook">Add a new Alertmanager receiver and a slack webhook</a>
    <ul>
      <li>
        <a href="/add-new-receiver-alert-manager.html#add-a-new-alertmanager-receiver-and-a-slack-webhook-pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/add-new-receiver-alert-manager.html#creating-a-new-receiver-set">Creating a new receiver set</a>
      </li>
      <li>
        <a href="/add-new-receiver-alert-manager.html#information-alerts">Information Alerts</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/disaster-recovery.html#cloud-platform-disaster-recovery">Cloud Platform Disaster Recovery</a>
    <ul>
      <li>
        <a href="/disaster-recovery.html#restore-process">Restore process</a>
      </li>
      <li>
        <a href="/disaster-recovery.html#apply-cloud-platform-resources">Apply cloud-platform resources</a>
      </li>
      <li>
        <a href="/disaster-recovery.html#cloud-platform-disaster-recovery-create-a-new-cluster">Create a new cluster</a>
      </li>
      <li>
        <a href="/disaster-recovery.html#perform-the-restore">Perform the restore</a>
        <ul>
          <li>
            <a href="/disaster-recovery.html#perform-the-restore-pre-requisites">Pre-requisites</a>
          </li>
          <li>
            <a href="/disaster-recovery.html#restore-the-cluster-using-etcd-manager-ctl-on-your-computer">Restore the cluster using etcd-manager-ctl on your computer.</a>
          </li>
          <li>
            <a href="/disaster-recovery.html#restore-process-inside-the-etcd-container-using-etcd-manager-ctl">Restore process inside the etcd container using etcd-manager-ctl.</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/disaster-recovery.html#cleanup">Cleanup</a>
      </li>
      <li>
        <a href="/disaster-recovery.html#possible-issues">Possible Issues</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/rotate-user-aws-credentials.html#rotate-user-aws-credentials">Rotate User AWS Credentials</a>
    <ul>
      <li>
        <ul>
          <li>
          </li>
          <li>
            <a href="/rotate-user-aws-credentials.html#2-identify-the-compromised-terraform-object">2. Identify the compromised terraform object</a>
          </li>
          <li>
            <a href="/rotate-user-aws-credentials.html#3-destroy-the-compromised-key">3. Destroy the compromised key</a>
          </li>
          <li>
            <a href="/rotate-user-aws-credentials.html#4-let-terraform-create-a-new-key">4. Let terraform create a new key</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/aws-leaked-credentials.html#aws-compromised-credentials">AWS Compromised Credentials</a>
    <ul>
      <li>
        <a href="/aws-leaked-credentials.html#steps-for-a-leaked-credentials">Steps for a leaked credentials</a>
      </li>
      <li>
        <a href="/aws-leaked-credentials.html#getting-new-credentials">Getting new credentials</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/aws-create-user.html#aws-console-access">AWS Console Access</a>
    <ul>
      <li>
        <a href="/aws-create-user.html#steps-to-create-delete-users">Steps to create/delete users</a>
      </li>
      <li>
        <a href="/aws-create-user.html#activating-mfa-for-new-users">Activating MFA for new users</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/delete-prometheus-metrics.html#delete-prometheus-metrics">Delete Prometheus Metrics</a>
    <ul>
      <li>
        <a href="/delete-prometheus-metrics.html#1-identify-the-metrics-you-want-to-delete">1.  Identify the metrics you want to delete</a>
      </li>
      <li>
        <a href="/delete-prometheus-metrics.html#2-enable-the-admin-interface-in-prometheus">2. Enable the admin interface in Prometheus</a>
      </li>
      <li>
        <a href="/delete-prometheus-metrics.html#3-launch-a-port-forward-pod">3. Launch a port-forward pod</a>
      </li>
      <li>
        <a href="/delete-prometheus-metrics.html#4-forward-local-traffic-to-prometheus">4. Forward local traffic to Prometheus</a>
      </li>
      <li>
        <a href="/delete-prometheus-metrics.html#5-use-curl-in-another-terminal-to-hit-the-api-endpoint">5. Use curl (in another terminal) to hit the API endpoint</a>
      </li>
      <li>
        <a href="/delete-prometheus-metrics.html#6-use-this-script-to-delete-multiple-metrics">6. Use this script to delete multiple metrics</a>
      </li>
      <li>
        <a href="/delete-prometheus-metrics.html#7-clean-up">7. Clean up</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/remove-orphaned-namespace.html#remove-39-orphaned-39-namespaces-and-aws-resources">Remove ‘orphaned’ namespaces and AWS resources</a>
    <ul>
      <li>
        <ul>
          <li>
            <a href="/remove-orphaned-namespace.html#1-git-clone-the-environments-checker-repository">1. git clone the environments checker repository</a>
          </li>
          <li>
            <a href="/remove-orphaned-namespace.html#2-create-a-env-live1-file-containing-the-environment-variables-the-checker-requires">2. Create a .env.live1 file, containing the environment variables the checker requires</a>
          </li>
          <li>
            <a href="/remove-orphaned-namespace.html#3-do-a-dry-run-of-deleting-the-target-namespace">3. Do a dry run of deleting the target namespace</a>
          </li>
          <li>
            <a href="/remove-orphaned-namespace.html#4-delete-the-aws-resources-and-the-cluster-namespace">4. Delete the AWS resources and the cluster namespace</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/remove-orphaned-namespace.html#possible-errors">Possible Errors</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/manually-apply-namespace.html#manually-plan-apply-namespace-resources">Manually Plan/Apply Namespace Resources</a>
    <ul>
      <li>
        <a href="/manually-apply-namespace.html#start-in-the-appropriate-branch-of-the-environments-repo">Start in the appropriate branch of the environments repo</a>
      </li>
      <li>
        <a href="/manually-apply-namespace.html#target-the-live-1-cluster">Target the live-1 cluster</a>
      </li>
      <li>
        <a href="/manually-apply-namespace.html#set-some-environment-variables">Set some environment variables</a>
      </li>
      <li>
        <a href="/manually-apply-namespace.html#set-the-namespace-name">Set the namespace name</a>
      </li>
      <li>
        <a href="/manually-apply-namespace.html#terraform-init">Terraform Init</a>
      </li>
      <li>
        <a href="/manually-apply-namespace.html#terraform-plan-apply">Terraform Plan/Apply</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/manually-delete-namespace-resources.html#manually-delete-namespace-resources">Manually Delete Namespace Resources</a>
  </li>
</ul>
<ul>
  <li>
    <a href="/remove-data-from-elasticsearch.html#remove-data-from-elasticsearch">Remove data from Elasticsearch</a>
    <ul>
      <li>
        <a href="/remove-data-from-elasticsearch.html#things-to-know">Things to know</a>
      </li>
      <li>
        <a href="/remove-data-from-elasticsearch.html#build-your-query">Build your query</a>
      </li>
      <li>
        <a href="/remove-data-from-elasticsearch.html#delete-by-query">Delete by query</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/delete-state-lock.html#delete-terraform-state-lock">Delete terraform state lock</a>
  </li>
</ul>
<ul>
  <li>
    <a href="/error-refreshing-state.html#terraform-state-lock-error-refreshing-state">Terraform state lock - Error refreshing state</a>
  </li>
</ul>
<ul>
  <li>
    <a href="/replacing-master-node.html#replacing-a-master-node">Replacing a master node</a>
    <ul>
      <li>
        <a href="/replacing-master-node.html#replacing-a-master-node-pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/replacing-master-node.html#identify-the-failed-master-node">Identify the failed master node</a>
      </li>
      <li>
        <a href="/replacing-master-node.html#remove-the-unhealthy-master-node">Remove the unhealthy master node.</a>
      </li>
      <li>
        <a href="/replacing-master-node.html#replacing-the-master-via-kops">Replacing the master via kops</a>
      </li>
      <li>
        <a href="/replacing-master-node.html#etcd-volumes">etcd volumes</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/recycle-node.html#recycle-node">Recycle-node</a>
    <ul>
      <li>
        <a href="/recycle-node.html#guidance-for-cloud-platform-team-when-recycle-node-pipeline-job-fails">Guidance for cloud-platform team, when recycle-node pipeline job fails:</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/eks-tools-cluster.html#provisioning-eks-clusters">Provisioning EKS clusters</a>
    <ul>
      <li>
        <a href="/eks-tools-cluster.html#provisioning-eks-clusters-pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/eks-tools-cluster.html#provisioning">Provisioning</a>
        <ul>
          <li>
            <a href="/eks-tools-cluster.html#1-vpc">1. VPC</a>
          </li>
          <li>
            <a href="/eks-tools-cluster.html#2-creating-eks-cluster">2. Creating EKS cluster</a>
          </li>
          <li>
            <a href="/eks-tools-cluster.html#3-deploy-components">3. Deploy components</a>
          </li>
          <li>
            <a href="/eks-tools-cluster.html#4-delete-the-eks-cluster">4. Delete the EKS cluster</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/eks-tools-cluster.html#todo">TODO</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/post-migration.html#post-migration-cleanup">Post migration cleanup</a>
    <ul>
      <li>
        <a href="/post-migration.html#table-of-contents">Table of contents</a>
      </li>
      <li>
        <a href="/post-migration.html#when-to-use-this-document">When to use this document?</a>
      </li>
      <li>
        <a href="/post-migration.html#0-pre-requisites">0 Pre-requisites</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#1-turn-off-template-deploy-monitoring-and-alerting">1 Turn off Template Deploy monitoring and alerting</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#2-archive-the-deployment-repository">2 Archive the deployment repository</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#3-backup-old-template-deploy-data">3 Backup old Template Deploy data</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#4-delete-the-old-cloudformation-stack">4 Delete the old CloudFormation stack</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#5-ensure-removal-of-resources">5 Ensure removal of resources</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/post-migration.html#6-ensure-live-service-is-still-functioning">6 Ensure live service is still functioning!</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/expand.html#expanding-persistent-volumes-created-using-statefulsets">Expanding Persistent Volumes created using StatefulSets</a>
  </li>
</ul>
<ul>
  <li>
    <a href="/velero.html#velero-cluster-backups-and-disaster-recovery">Velero - Cluster backups and disaster recovery</a>
    <ul>
      <li>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/velero.html#backups">Backups</a>
        <ul>
          <li>
            <a href="/velero.html#why">Why?</a>
          </li>
          <li>
            <a href="/velero.html#what">What?</a>
          </li>
          <li>
            <a href="/velero.html#how">How?</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/running-kops-update-rollingupdate.html#running-kops-update-and-rollingupdate">Running Kops Update and Rollingupdate</a>
    <ul>
      <li>
        <a href="/running-kops-update-rollingupdate.html#using-kops-to-change-the-cluster">Using kops to change the cluster</a>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#running-kops-update-and-rollingupdate-pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#updating-the-kops-state">Updating the kops state</a>
        <ul>
          <li>
            <a href="/running-kops-update-rollingupdate.html#generating-an-updated-kops-config-file">Generating an updated kops config file</a>
          </li>
          <li>
            <a href="/running-kops-update-rollingupdate.html#applying-local-changes-to-the-kops-state-store">Applying local changes to the kops state store</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#running-kops-update">Running Kops update</a>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#running-kops-rolling-update">Running Kops rolling-update</a>
      </li>
      <li>
        <a href="/running-kops-update-rollingupdate.html#running-kops-update-and-rollingupdate-possible-errors">Possible Errors</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/helm-repository.html#cloud-platform-helm-chart-repository">Cloud Platform helm chart repository</a>
    <ul>
      <li>
        <a href="/helm-repository.html#workflow-to-update-helm-charts">Workflow to update helm charts</a>
        <ul>
          <li>
            <a href="/helm-repository.html#1-make-the-change">1. Make the change</a>
          </li>
          <li>
            <a href="/helm-repository.html#2-create-the-tarball">2. Create the tarball</a>
          </li>
          <li>
            <a href="/helm-repository.html#3-generate-index-yaml">3. Generate index.yaml</a>
          </li>
          <li>
            <a href="/helm-repository.html#4-commit-and-create-the-pr">4. Commit and create the PR</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/access-eks-cluster.html#access-eks-cluster">Access EKS cluster</a>
    <ul>
      <li>
        <a href="/access-eks-cluster.html#access-eks-cluster-pre-requisites">Pre-requisites</a>
        <ul>
          <li>
            <a href="/access-eks-cluster.html#create-kubeconfig-using-aws-command">Create kubeconfig using aws command</a>
          </li>
          <li>
            <a href="/access-eks-cluster.html#create-kubeconfig-manually-using-template">Create kubeconfig manually using template</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-new-opa-policy.html#open-policy-agent-policies">Open Policy Agent policies</a>
    <ul>
      <li>
        <a href="/add-new-opa-policy.html#adding-a-policy">Adding a policy</a>
      </li>
      <li>
        <a href="/add-new-opa-policy.html#writing-tests">Writing tests</a>
      </li>
      <li>
        <a href="/add-new-opa-policy.html#references">References</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/joiners-guide.html#joiners-guide">Joiners Guide</a>
    <ul>
      <li>
        <a href="/joiners-guide.html#people-team">People Team</a>
      </li>
      <li>
        <a href="/joiners-guide.html#service-desk">Service Desk</a>
      </li>
      <li>
        <a href="/joiners-guide.html#sit-down-with-dm">SIT down with DM</a>
      </li>
      <li>
        <a href="/joiners-guide.html#cloud-platform-team">Cloud Platform team</a>
      </li>
      <li>
        <a href="/joiners-guide.html#access">ACCESS</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/leavers-guide.html#leavers-guide">Leavers Guide</a>
    <ul>
      <li>
        <a href="/leavers-guide.html#revoking-access">Revoking Access</a>
        <ul>
          <li>
            <a href="/leavers-guide.html#digital-services">Digital Services</a>
          </li>
          <li>
            <a href="/leavers-guide.html#aws-accounts">AWS Accounts</a>
          </li>
          <li>
            <a href="/leavers-guide.html#template-deploy-cloud-platforms">Template Deploy - Cloud Platforms</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/on-call.html#going-on-call">Going on call</a>
    <ul>
      <li>
        <a href="/on-call.html#what-s-expected">What’s expected?</a>
        <ul>
          <li>
            <a href="/on-call.html#expected">Expected:</a>
          </li>
          <li>
            <a href="/on-call.html#not-expected">Not Expected:</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/on-call.html#where-do-i-start">Where do I start?</a>
      </li>
      <li>
        <a href="/on-call.html#what-do-i-get-for-being-on-call">What do I get for being on call?</a>
      </li>
      <li>
        <a href="/on-call.html#civil-servants-sop-claim">Civil servants - SOP Claim</a>
      </li>
      <li>
        <a href="/on-call.html#civil-servants-sop-problem-resolution">Civil servants - SOP Problem Resolution</a>
      </li>
      <li>
        <a href="/on-call.html#contractors">Contractors</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/manual-ssl-certificate-processes.html#create-manual-ssl-certificate-processes">Create Manual SSL Certificate Processes</a>
    <ul>
      <li>
        <a href="/manual-ssl-certificate-processes.html#create-manual-ssl-certificate-processes-pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/manual-ssl-certificate-processes.html#requesting-a-new-certificate-via-gandi-net">Requesting a new certificate via Gandi.net</a>
      </li>
      <li>
        <a href="/manual-ssl-certificate-processes.html#renewing-a-new-certificate-via-gandi-net">Renewing a new certificate via Gandi.net</a>
      </li>
      <li>
        <a href="/manual-ssl-certificate-processes.html#revoking-gandi-net-certificates">Revoking Gandi.net certificates</a>
      </li>
      <li>
        <a href="/manual-ssl-certificate-processes.html#costs-funding-information">Costs/Funding information</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/os-places-api-key-management.html#os-places-api-key-management">OS Places API Key Management</a>
    <ul>
      <li>
        <a href="/os-places-api-key-management.html#os-places-api-key-management-pre-requisites">Pre-requisites</a>
      </li>
      <li>
        <a href="/os-places-api-key-management.html#creating-a-new-api-key">Creating a new API key</a>
      </li>
      <li>
        <a href="/os-places-api-key-management.html#revoking-an-api-key">Revoking an API key</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/tips-and-tricks.html#tips-and-tricks">Tips and Tricks</a>
    <ul>
      <li>
        <a href="/tips-and-tricks.html#check-the-expiration-date-of-the-ssl-certificate-for-a-live-domain">Check the expiration date of the SSL certificate for a live domain</a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#run-etcdctl-on-a-master-node">Run etcdctl on a master node</a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#delete-a-quot-stuck-quot-resource">Delete a “stuck” resource</a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#filter-namespaces-by-specific-label-or-annotation">Filter namespaces by specific label or annotation</a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#find-all-pods-running-on-a-specific-worker-node">Find all pods running on a specific worker node</a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#install-tmux-and-docker-on-the-live-1-bastion-host">Install tmux and docker on the live-1 bastion host</a>
      </li>
      <li>
        <a href="/tips-and-tricks.html#output-all-records-from-route53-as-a-csv-file">Output all records from Route53 as a CSV file</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/template-deploy-run-books.html#template-deploy-runbooks">Template-deploy Runbooks</a>
    <ul>
      <li>
        <a href="/template-deploy-run-books.html#general-incident-procedure">General Incident Procedure</a>
      </li>
      <li>
        <a href="/template-deploy-run-books.html#existing-runbooks">Existing Runbooks</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/add-a-new-runbook.html#add-a-new-runbook">Add a new runbook</a>
    <ul>
      <li>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <h1 id="recycle-node">Recycle-node</h1><p><a href="https://github.com/ministryofjustice/cloud-platform-concourse/blob/master/pipelines/live-1/main/recycle-node.yaml">Recycle-node pipeline</a> runs every week-day, which executes the <a href="https://github.com/ministryofjustice/cloud-platform-infrastructure/blob/master/recycle-node.rb">recycle-node.rb</a> script to replace the oldest worker node by:</p>

<ul>
<li>Draining the oldest node</li>
<li>Terminate the drained node.</li>
</ul>
<h2 id="guidance-for-cloud-platform-team-when-recycle-node-pipeline-job-fails">Guidance for cloud-platform team, when recycle-node pipeline job fails:</h2><p>There are couple of reasons where <a href="https://concourse.cloud-platform.service.justice.gov.uk/teams/main/pipelines/recycle-node">recycle-node pipeline</a> job may fail.</p>
<p>1) <code>error: unable to drain node &quot;ip-172-20-xxx-xxx.eu-west-2.compute.internal&quot;, aborting command...</code></p>
<p>Recycle-node pipeline may fail because the pods exist without being part of a replicaset. These seem to be port-forward pods, usually used by developers to connect to an RDS instance from their development environment.</p>
<p>We&rsquo;re running the process in a relatively gentle way, so it just fail the pipeline, rather than force-draining the node (which would have destroyed these pods).</p>
<p>The error will be similar as below from the logs of the recycle-node pipeline.</p>
<div class="highlight"><pre class="highlight plaintext"><code>There are pending nodes to be drained:
 ip-172-20-123-244.eu-west-2.compute.internal
error: pods not managed by ReplicationController, ReplicaSet, Job, DaemonSet or StatefulSet (use --force to override): port-forward
</code></pre></div><p>If <a href="https://concourse.cloud-platform.service.justice.gov.uk/teams/main/pipelines/recycle-node">pipeline logs</a> is not showing the pods which is causing the issue, using the node name form above, run the below command:</p>
<div class="highlight"><pre class="highlight plaintext"><code> kubectl --ignore-daemonsets --delete-local-data drain ip-172-20-123-244.eu-west-2.compute.internal
</code></pre></div><p>It will show similar message from recycle-node pipeline logs, but also give the list of pods, which is causing the error.</p>
<div class="highlight"><pre class="highlight plaintext"><code>There are pending nodes to be drained:
 ip-172-20-123-244.eu-west-2.compute.internal
error: cannot delete Pods not managed by ReplicationController, ReplicaSet, Job, DaemonSet or StatefulSet (use --force to override): licences-dev/port-forward
</code></pre></div><p>Since developers create port-forward pods only used briefly, we track down the namespace owner and ask them to clear them up, by sending a message in the #ask-cloud-platform, something like below.</p>
<div class="highlight"><pre class="highlight plaintext"><code>Recycle-node job failed to replace the node, as it failed to drain the pod.
If any of these pods are yours, and you're not using them anymore, please could you delete them so that the next time the recycle-node job runs, it is able to replace the node.

licences-dev/port-forward
</code></pre></div><p>Once the pod which is causing the issue gets deleted, re-run the pipeline which will drain the node successfully and terminate the drained node.</p>
<p>2) <code>error when evicting pod &quot;some-pod-84d68b65b8-cl6xq&quot; (will retry after 5s): Cannot evict pod as it would violate the pod&#39;s disruption budget</code></p>
<p>This is because pod may stuck in ImagePullBackoff status. The error is misleading, as error message talks about pod disruption budgets.</p>
<p>In this case identify the pod and delete it manually and re-run the pipeline which will drain the node successfully and terminate the drained node.</p>


              <div data-module='page-expiry' data-last-reviewed-on="2020-03-11">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 11 December 2019.

        It needs to be reviewed again on 11 March 2020
        by the page owner <a href="https://mojdt.slack.com/messages/cloud-platform">#cloud-platform</a>
        .
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 11 March 2020
       by the page owner <a href="https://mojdt.slack.com/messages/cloud-platform">#cloud-platform</a>.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

            <ul class="contribution-banner">
              <li><a href="https://github.com/ministryofjustice/cloud-platform/blob/master/source/recycle-node.html.md.erb">View source</a></li>
              <li><a href="https://github.com/ministryofjustice/cloud-platform/issues/new?labels=bug&amp;title=Re:%20'Guidance%20when%20recycle-node%20pipeline%20job%20fails'&amp;body=Problem%20with%20'Guidance%20when%20recycle-node%20pipeline%20job%20fails'%20(https://runbooks.cloud-platform.service.justice.gov.uk/recycle-node.html)">Report problem</a></li>
              <li><a href="https://github.com/ministryofjustice/cloud-platform">GitHub Repo</a></li>
            </ul>

          <footer class="footer">
  <div class="footer__licence">
    <a class="footer__licence-logo" href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence</a>
    <p class="footer__licence-description">All content is available under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence v3.0</a>, except where otherwise stated</p>
  </div>

  <div class="footer__copyright">
    <a class="footer__copyright-logo" href="http://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/copyright-and-re-use/crown-copyright/">© Crown copyright</a>
  </div>
</footer>

        </div>
      </div>
    </div>

    
  </body>
</html>
